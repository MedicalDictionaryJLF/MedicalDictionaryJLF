<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medical Dictionary — web copy</title>
  <style>
  :root{
    /* GREEN THEME */
    --brand:#15803d;        /* emerald/green */
    --brand-2:#166534;      /* darker green */
    --bg:#f3f6f4;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:rgba(17,24,39,.10);
    --shadow:0 8px 30px rgba(17,24,39,.10);
    --radius:14px;

    /* Background image: put a file next to index.html named "background.jpg" */
    --hero-bg: url('background.jpg');
  }

  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);line-height:1.35;font-size:var(--base-font-size,16px)}
  body::before{
    content:"";
    position:fixed;
    inset:0;
    z-index:-1;
    background:
      linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.15)),
      var(--hero-bg);
    background-size:cover;
    background-position:center;
    opacity:.95;
    pointer-events:none;
  }
  :root{
    --leafy-bg: var(--hero-bg);
  }

  /* Header */
  header{
    position:sticky;top:0;z-index:50;
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 18px;
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:white;
    box-shadow:0 6px 20px rgba(0,0,0,.14);
  }
  .header-left{display:flex;align-items:center;gap:14px;min-width:240px}
  header h1{margin:0;font-size:18px;letter-spacing:.2px;font-weight:650}
  .whoami{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.18);
    font-size:13px;
    white-space:nowrap;
  }
  .whoami strong{font-weight:700}

  /* Bigger cog */
  .settings-btn{
    background:rgba(255,255,255,.78);
    border:1px solid rgba(255,255,255,.55);
    border-radius:14px;
    color:white;
    cursor:pointer;
    padding:12px;                 /* bigger */
  }
  .settings-btn:hover{background:rgba(255,255,255,.16)}
  .settings-btn svg{width:24px;height:24px;fill:currentColor;display:block} /* bigger icon */

  /* Layout */
  main{padding:22px}
  .screen{max-width:1100px;margin:0 auto;min-height:calc(100vh - 74px);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .hidden{display:none!important}
  .screen h2{
    width:min(920px, 100%);
    margin:0 0 12px 0;
  }

  /* Cards & controls */
  .card{
    width:min(920px, 100%);
    background:var(--card);
    padding:18px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
  }

  input,select,textarea,button{font-size:inherit;padding:10px 12px}
  input,textarea,select{
    width:100%;
    margin:8px 0;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    outline:none;
  }
  input:focus,textarea:focus,select:focus{
    border-color:rgba(21,128,61,.45);
    box-shadow:0 0 0 4px rgba(21,128,61,.15)
  }
  textarea{min-height:92px;resize:vertical}

  button{
    cursor:pointer;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    transition:transform .03s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{background:#f8fafc}
  button:active{transform:translateY(1px)}
  button.primary{background:var(--brand);border-color:rgba(255,255,255,.0);color:#fff}
  button.primary:hover{background:#137a38}
  button.danger{background:#fff;border-color:rgba(220,38,38,.25);color:#991b1b}
  button.danger:hover{background:#fff5f5}
  .linklike{background:transparent;border:none;color:var(--brand);cursor:pointer;text-decoration:underline;padding:8px 0}

  .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .row > *{flex:1 1 180px}

  .muted{color:var(--muted);margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  .scrollable{max-height:62vh;overflow:auto;padding-right:4px}
  .checkbox-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:8px;
    margin:8px 0;
  }
  .checkbox-item{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 8px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
  }
  .muscle-result{
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    margin-top:10px;
    background:#fff;
  }
  .muscle-field{
    display:flex;
    gap:8px;
    padding:6px 0;
    border-bottom:1px solid var(--border);
  }
  .muscle-field:last-child{border-bottom:none}
  .muscle-field-toggle{
    display:flex;
    align-items:center;
    gap:6px;
    min-width:28px;
  }
  .muscle-field-toggle.right{
    margin-left:auto;
    justify-content:flex-end;
  }
  .muscle-field-toggle input[type="checkbox"],
  .checkbox-grid input[type="checkbox"],
  .muscle-region-header input[type="checkbox"]{
    width:14px;
    height:14px;
    margin:0;
    padding:0;
  }
  .muscle-field-value{
    flex:1;
  }
  .anam-section{
    padding:8px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    margin-top:12px;
  }
  .anam-section h3{
    margin:0 0 8px 0;
    font-size:16px;
  }
  .anam-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:10px;
  }
  .anam-row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .anam-row label{
    display:flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .anam-table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  .anam-table th,
  .anam-table td{
    border:1px solid var(--border);
    padding:6px 8px;
    vertical-align:top;
  }
  .muscle-region-item{
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px 10px;
    margin:8px 0;
    background:#fff;
  }
  .muscle-region-header{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .muscle-region-categories{
    margin-top:8px;
  }
  .muscle-field-label{min-width:140px;color:var(--muted)}

  /* Settings sidebar */
  #settings-sidebar{
    position:fixed;top:0;right:-340px;width:340px;height:100vh;
    background:white;box-shadow:-2px 0 35px rgba(0,0,0,0.18);
    transition:right 0.25s ease;padding:20px;z-index:1000;
    border-left:1px solid var(--border);
  }
  #settings-sidebar.open{right:0}
  #settings-close:hover{background:#f8fafc}

  /* overlay (fix color) */
  #settings-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.40);
    opacity:0;visibility:hidden;transition:opacity 0.2s;z-index:999
  }
  #settings-overlay.open{opacity:1;visibility:visible}

  .modal-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.45);
    display:flex;align-items:center;justify-content:center;
    z-index:998;
  }
  .modal{
    width:min(520px, 92%);
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    box-shadow:var(--shadow);
  }
  .modal h3{margin:0 0 8px 0}
  .modal p{margin:0 0 14px 0;color:var(--muted)}

  .settings-block{
    padding:12px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    margin-top:12px;
  }
  .text-size-wrap{display:flex;flex-direction:column;gap:6px}
  .text-size-labels{display:flex;justify-content:space-between;font-size:0.9em;color:var(--muted)}
  .text-size-slider{width:100%}
  .settings-block h4{margin:0 0 10px 0;font-size:14px}
  .settings-actions button{width:100%;margin-top:10px}
  .settings-status{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }
  .lang-flag{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:6px 8px;
    font-size:18px;
    line-height:1;
  }
  .lang-flag:hover{background:#f8fafc}

  /* --- HERO (Menu screen) --- */
  #screen-menu{
    max-width:none;width:100%;
    padding:0;
  }
  #screen-menu .hero{
    width:100%;
    min-height:calc(100vh - 74px);
    display:flex;align-items:center;justify-content:center;
    background:
      linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.45)),
      var(--hero-bg, var(--leafy-bg)); /* leafy */
    background-size:cover;
    background-position:center;
    padding:26px;
  }
  #screen-menu .hero-inner{
    width:min(980px, 100%);
    text-align:center;
    color:#fff;
  }
  #screen-menu .hero-title{
    font-size:42px;
    font-weight:750;
    letter-spacing:.2px;
    margin:0 0 8px 0;
    text-shadow:0 10px 28px rgba(0,0,0,.45);
  }
  #screen-menu .hero-sub{
    margin:0 0 16px 0;
    font-size:18px;
    opacity:.92
  }
  #screen-menu .hero-card{
    margin:18px auto 0;
    width:min(920px, 100%);
    background:rgba(0,0,0,.30);
    border:1px solid rgba(255,255,255,.25);
    border-radius:18px;
    padding:18px;
    backdrop-filter: blur(8px);
    box-shadow:0 18px 60px rgba(0,0,0,.25);
  }

  /* Language buttons like your app screenshot */
  .lang-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    margin-top:12px;
  }
  .lang-grid button{
    padding:14px 14px;
    font-weight:650;
    background:rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.22);
    color:#fff;
  }
  .lang-grid button:hover{background:rgba(255,255,255,.22)}
  .lang-grid button:active{transform:translateY(1px)}

  
  /* Light variant of language grid (for white cards like Login screen) */
  .lang-grid.light button{
    color:var(--text);
    background:#fff;
    border:1px solid var(--border);
  }
  .lang-grid.light button:hover{background:#f8fafc}
/* Cambridge-like search panel */
  #screen-search .card, #screen-entry .card, #screen-quiz .card, #screen-submenu .card, #screen-login .card{
    padding:20px;
  }
  #screen-submenu .card{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  #screen-submenu .card button{
    width:100%;
  }
  #screen-search .card{
    border-radius:18px;
  }
  #search-input{
    font-size:18px;
    padding:14px 14px;
    border-radius:14px;
  }
  #search-results{margin-top:14px}
  .result{
    padding:14px 14px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    box-shadow:0 6px 16px rgba(17,24,39,.06);
    margin:10px 0;
  }
  .result strong{font-size:18px}
  .kv{
    display:grid;
    grid-template-columns:150px 1fr;
    gap:8px 14px;
    margin-top:10px;
    align-items:start;
  }
  .k{color:var(--muted);font-size:13px}
  .v{color:var(--text);font-size:15px}

  @media (max-width:700px){
    #screen-menu .hero-title{font-size:34px}
    .kv{grid-template-columns:110px 1fr}
    .whoami{display:none} /* keep header clean on small screens */
  }
</style>
</head>
<body>
  <div id="app">
    <header>
      <div class="header-left">
        <h1 id="app-title">Medical Dictionary</h1>

        <!-- shown ONLY after login -->
        <div id="header-whoami" class="whoami hidden">
          Logged in as: <strong id="header-user">—</strong>
        </div>
      </div>

      <!-- SETTINGS COG: always visible -->
      <button type="button" class="settings-btn" id="settings-toggle" aria-label="Settings">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      </button>
    </header>

    <div id="settings-overlay"></div>
    <div id="settings-sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 10px 0">
        <h3 style="margin:0">Settings</h3>
        <button type="button" id="settings-close" aria-label="Close settings" style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;cursor:pointer">></button>
      </div>

      <div class="settings-block">
        <h4 data-i18n="settings_language">Language</h4>
        <div class="anam-row" style="justify-content:flex-start">
          <button type="button" class="lang-btn lang-flag" data-lang="Slovensky" aria-label="Slovak">SK</button>
          <button type="button" class="lang-btn lang-flag" data-lang="Deutch" aria-label="German">DE</button>
          <button type="button" class="lang-btn lang-flag" data-lang="English" aria-label="English">EN</button>
        </div>
      </div>

      <!-- MOVED HERE: Sync + Return to menu (only useful when logged in) -->
      <div class="settings-block hidden" id="settings-sync-block">
        <h4>Account & Sync</h4>

        <div class="settings-actions">
          <button type="button" id="btn-sync" class="primary">Sync</button>
          <button type="button" id="to-menu">Back to Language Menu</button>
          <button type="button" id="to-login-from-settings">Return to Login</button>
        </div>

        <div class="settings-status">
          Sync: <span id="sync-status">not synced</span> ? Unsynced changes: <span id="sync-dirty-count">0</span>
        </div>

        <div class="settings-status" style="margin-top:8px">
          Logged in as: <strong id="current-user">(none)</strong>
        </div>
      </div>

      <div class="settings-block">
        <h4 data-i18n="settings_text_size">Text size</h4>
        <div class="text-size-wrap">
          <div class="text-size-labels">
            <span data-i18n="text_size_small">Small</span>
            <span data-i18n="text_size_large">Large</span>
          </div>
          <input id="text-size-slider" class="text-size-slider" type="range" min="1" max="7" step="1" />
        </div>
      </div>
    </div>

    <div id="guest-overlay" class="modal-overlay hidden">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="guest-title">
        <h3 id="guest-title" data-i18n="guest_title">Continue without account?</h3>
        <p data-i18n="guest_desc">Your progress won't be saved. To save your progress, login or register your account.</p>
        <div class="row">
          <button type="button" id="guest-continue" class="primary" data-i18n="continue">Continue</button>
          <button type="button" id="guest-back" data-i18n="back">Back</button>
        </div>
      </div>
    </div>

    <div id="forgot-overlay" class="modal-overlay hidden">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="forgot-title">
        <h3 id="forgot-title" data-i18n="forgot_password_title">Forgot password</h3>
        <p data-i18n="forgot_password_desc">Enter your email to receive a reset link.</p>
        <input id="forgot-email" type="email" placeholder="Email" data-i18n-placeholder="forgot_password_email_placeholder" />
        <div class="row">
          <button type="button" id="forgot-send" class="primary" data-i18n="forgot_password_send">Send</button>
          <button type="button" id="forgot-cancel" data-i18n="forgot_password_cancel">Cancel</button>
        </div>
        <p id="forgot-msg" class="muted"></p>
      </div>
    </div>

    <main>
      <section id="screen-menu" class="screen">
        <div class="hero">
          <div class="hero-inner">
            <p class="hero-sub" data-i18n="welcome">Welcome</p>

            <div class="hero-card">
              <h3 style="margin:0 0 8px 0;font-weight:700" data-i18n="choose_language">Choose language</h3>
              <p style="margin:0 0 12px 0;font-weight:100;font-size:14px" data-i18n="language_settings">May later change in settings</p>
              <div class="lang-grid">
                <button type="button" class="lang-btn" data-lang="English">English</button>
                <button type="button" class="lang-btn" data-lang="Deutch">Deutch</button>
                <button type="button" class="lang-btn" data-lang="Slovensky">Slovensky</button>              </div>

              <div class="row" style="margin-top:16px">
                <button type="button" id="to-login" class="primary" data-i18n="Login">Login</button>
                <button type="button" id="to-register" data-i18n="Register">Register</button>
              </div>

              <div class="row" style="margin-top:10px">
                <button type="button" id="continue-guest" data-i18n="continue_without_account">Continue without account</button>
              </div>

              <div class="small" style="margin-top:10px;opacity:.9" data-i18n="please_note">Please note: This web version is still in development…
                <br />
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="screen-login" class="screen hidden">
        <h2 id="login-title" data-i18n="Login or Register">Login or Register</h2>
<div class="card">
          <div id="login-status" class="muted" style="display:none;margin-bottom:10px;padding:10px;border-radius:8px;"></div>
          <div id="login-form">
            <input id="username" placeholder="Email or username" data-i18n-placeholder="email_or_username" />
            <input id="password" type="password" placeholder="Password" data-i18n-placeholder="Password" />
            <div class="row">
              <button type="button" id="btn-login" data-i18n="Login">Login</button>
              <button type="button" id="btn-show-register" data-i18n="Register">Register</button>
            </div>
            <button type="button" id="btn-forgot" class="linklike" data-i18n="forgot_password_button">Forgot password?</button>
            <p id="login-msg" class="muted"></p>
          </div>

          <div id="register-form" class="hidden">
            <input id="reg-username" placeholder="Username" data-i18n-placeholder="Username" />
            <input id="reg-email" type="email" placeholder="Email" data-i18n-placeholder="Email" />
            <input id="reg-password" type="password" placeholder="Password" data-i18n-placeholder="Password" />
            <input id="reg-password-confirm" type="password" placeholder="Confirm password" data-i18n-placeholder="Confirm password" />
            <div class="row">
              <button type="button" id="btn-register" data-i18n="Register">Create account</button>
              <button type="button" id="btn-show-login">Back</button>
            </div>
            <p id="register-msg" class="muted"></p>
          </div>
        </div>
      </section>

      <section id="screen-submenu" class="screen hidden">
        <h2 id="welcome-title">Welcome</h2>
        <div class="card">
          <button type="button" id="to-search" data-i18n="search">Search Terms</button>
          <button type="button" id="to-entry" data-i18n="add_term">Add Term</button>
          <button type="button" id="to-quiz" data-i18n="quiz">Quiz</button>
          <button type="button" id="to-muscle-training" data-i18n="muscle_training">Muscle training</button>
          <button type="button" id="to-anamnesis" data-i18n="anamnesis">Anamnesis</button>
          <button type="button" id="to-links">Links</button>

          <!-- REMOVED FROM HERE:
               - Sync button (moved to Settings)
               - Back to Language Menu button (moved to Settings)
               - Logged in as line (now in header + Settings)
          -->
        </div>
      </section>

      <section id="screen-search" class="screen hidden">
        <h2 data-i18n="search">Search</h2>
        <div class="card">
          <input id="search-input" placeholder="Enter term (min 2 chars)" data-i18n-placeholder="enter_term" />
          <div id="search-results"></div>
          <div class="row">
            <button type="button" id="search-back" data-i18n="back">Back</button>
          </div>
        </div>
      </section>

      <section id="screen-entry" class="screen hidden">
        <h2 data-i18n="add_term">Add Term</h2>
        <div class="card scrollable">
          <div id="entry-fields">
            <input data-field="latin_translation" placeholder="Latin translation" />
            <input data-field="english_translation" placeholder="English translation" />
            <textarea data-field="english_definition" placeholder="English definition"></textarea>
            <input data-field="german_translation" placeholder="German translation" />
            <textarea data-field="german_definition" placeholder="German definition"></textarea>
          </div>
          <div class="row">
            <button type="button" id="save-term" data-i18n="Save Term">Save Term</button>
            <button type="button" id="entry-back" data-i18n="back">Back</button>
          </div>
          <p id="entry-msg" class="muted"></p>
        </div>
      </section>

      <section id="screen-quiz" class="screen hidden">
        <h2 data-i18n="quiz">Quiz</h2>
        <div class="card">
          <div class="row">
            <label>From:</label>
            <select id="quiz-from">
              <option value="english_translation">English</option>
              <option value="german_translation">German</option>
              <option value="slovak_translation">Slovak</option>
              <option value="latin_translation">Latin</option>
            </select>
            <label>To:</label>
            <select id="quiz-to">
              <option value="latin_translation">Latin</option>
              <option value="english_translation">English</option>
              <option value="german_translation">German</option>
              <option value="slovak_translation">Slovak</option>
            </select>
          </div>
          <div id="quiz-area"></div>
          <div class="row">
            <button type="button" id="start-quiz" data-i18n="start_quiz">Start</button>
            <button type="button" id="quiz-back" data-i18n="back">Back</button>
          </div>
          <p id="quiz-score" class="muted"></p>
        </div>
      </section>

      <section id="screen-muscle-training" class="screen hidden">
        <h2 data-i18n="muscle_training">Muscle training</h2>
        <div class="card">
          <h3 style="margin:0 0 8px 0" data-i18n="muscle_search_title">Search muscles</h3>
          <div class="row" style="align-items:center">
            <input id="muscle-search-input" placeholder="Search muscle name (min 2 chars)" data-i18n-placeholder="search_muscle_text" />
            <select id="muscle-search-field">
              <option value="any" data-i18n="muscle_search_any">Any</option>
              <option value="region" data-i18n="muscle_search_region">Region</option>
              <option value="category" data-i18n="muscle_search_category">Category</option>
              <option value="english_muscle_name" data-i18n="muscle_search_english_name">English name</option>
              <option value="latin_muscle_name" data-i18n="muscle_search_latin_name">Latin name</option>
              <option value="type_of_movement" data-i18n="muscle_search_type_of_movement">Type of movement</option>
              <option value="insercio" data-i18n="muscle_search_insercio">Insercio</option>
              <option value="origo" data-i18n="muscle_search_origo">Origo</option>
              <option value="blood_supply" data-i18n="muscle_search_blood_supply">Blood supply</option>
              <option value="innervation" data-i18n="muscle_search_innervation">Innervation</option>
            </select>
          </div>
          <div id="muscle-search-results" class="scrollable"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin:0 0 8px 0" data-i18n="muscle_quiz_title">Muscle quiz</h3>
          <div id="muscle-region-list"></div>
          <div class="row">
            <button type="button" id="muscle-quiz-start" class="primary" data-i18n="start">Start</button>
            <button type="button" id="muscle-training-back" data-i18n="back">Back</button>
          </div>
          <p id="muscle-quiz-msg" class="muted"></p>
          <div id="muscle-quiz-area" class="hidden">
            <div id="muscle-quiz-fields"></div>
            <div class="row">
              <button type="button" id="muscle-quiz-reveal" data-i18n="reveal">Reveal</button>
              <button type="button" id="muscle-quiz-next" class="primary" data-i18n="next">Next</button>
            </div>
          </div>
        </div>
      </section>

      <section id="screen-anamnesis" class="screen hidden">
        <h2>Anamnesis</h2>
        <div class="card scrollable">
          <form id="anamnesis-form">
            <div class="anam-section">
              <h3>1. Identification</h3>
              <div class="anam-grid">
                <input name="ident_full_name" placeholder="Full name" />
                <input name="ident_dob_age" placeholder="Date of birth / Age" />
                <div class="anam-row">
                  <span>Sex</span>
                  <label><input type="radio" name="ident_sex" value="male" /> Male</label>
                  <label><input type="radio" name="ident_sex" value="female" /> Female</label>
                </div>
                <input name="ident_city" placeholder="Address (City)" />
                <input name="ident_admitted" placeholder="Admitted on (date/time)" />
              </div>
            </div>

            <div class="anam-section">
              <h3>2. Chief Complaint</h3>
              <textarea name="chief_complaint" placeholder="Main reason for admission (caregiver's / patient's words)"></textarea>
            </div>

            <div class="anam-section">
              <h3>3. History of Present Illness (SOCRATES)</h3>
              <div class="anam-grid">
                <input name="hpi_site" placeholder="Site / System involved" />
                <input name="hpi_onset" placeholder="Onset (When did it start?)" />
                <input name="hpi_onset_activity" placeholder="What were you doing at onset?" />
                <input name="hpi_timing" placeholder="Timing / Duration" />
                <input name="hpi_exacerbating" placeholder="Exacerbating factors" />
                <input name="hpi_relieving" placeholder="Relieving factors" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Character / Type of symptoms</span>
                <label><input type="checkbox" name="hpi_char_mild" /> Mild</label>
                <label><input type="checkbox" name="hpi_char_moderate" /> Moderate</label>
                <label><input type="checkbox" name="hpi_char_severe" /> Severe</label>
                <label><input type="checkbox" name="hpi_char_progressive" /> Progressive</label>
                <label><input type="checkbox" name="hpi_char_episodic" /> Episodic</label>
                <label><input type="checkbox" name="hpi_char_fluctuating" /> Fluctuating</label>
                <input name="hpi_char_other" placeholder="Other" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Character of pain</span>
                <label><input type="checkbox" name="hpi_pain_sharp" /> Sharp</label>
                <label><input type="checkbox" name="hpi_pain_dull" /> Dull</label>
                <label><input type="checkbox" name="hpi_pain_burning" /> Burning</label>
                <label><input type="checkbox" name="hpi_pain_pressing" /> Pressing</label>
                <label><input type="checkbox" name="hpi_pain_colicky" /> Colicky</label>
                <input name="hpi_pain_other" placeholder="Other" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Radiation</span>
                <label><input type="radio" name="hpi_radiation" value="no" /> No</label>
                <label><input type="radio" name="hpi_radiation" value="yes" /> Yes</label>
                <input name="hpi_radiation_where" placeholder="Where?" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Associated symptoms</span>
                <label><input type="checkbox" name="hpi_assoc_fever" /> Fever</label>
                <label><input type="checkbox" name="hpi_assoc_headache" /> Headache</label>
                <label><input type="checkbox" name="hpi_assoc_nausea" /> Nausea</label>
                <label><input type="checkbox" name="hpi_assoc_vomiting" /> Vomiting</label>
                <label><input type="checkbox" name="hpi_assoc_cough" /> Cough</label>
                <label><input type="checkbox" name="hpi_assoc_dyspnea" /> Dyspnea</label>
                <label><input type="checkbox" name="hpi_assoc_palpitations" /> Palpitations</label>
                <input name="hpi_assoc_other" placeholder="Other" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Severity (VAS)</span>
                <input name="hpi_vas" placeholder="1-10" />
              </div>
              <div class="anam-row" style="margin-top:8px">
                <span>Course since onset</span>
                <label><input type="checkbox" name="hpi_course_improving" /> Improving</label>
                <label><input type="checkbox" name="hpi_course_worsening" /> Worsening</label>
                <label><input type="checkbox" name="hpi_course_unchanged" /> Unchanged</label>
                <label><input type="checkbox" name="hpi_course_recurrent" /> Recurrent</label>
                <input name="hpi_course_other" placeholder="Other" />
              </div>
              <textarea name="hpi_notes" placeholder="Notes"></textarea>
            </div>
            <div class="anam-section">
              <h3>4. Review of Systems</h3>
              <div class="anam-row">
                <strong>General</strong>
                <label><input type="checkbox" name="ros_general_fever" /> Fever</label>
                <label><input type="checkbox" name="ros_general_weight_loss" /> Weight loss (12 months)</label>
                <label><input type="checkbox" name="ros_general_weight_gain" /> Weight gain (12 months)</label>
                <label><input type="checkbox" name="ros_general_fatigue" /> Fatigue</label>
                <label><input type="checkbox" name="ros_general_night_sweats" /> Night sweats</label>
              </div>
              <textarea name="ros_general_notes" placeholder="General - Other/Notes"></textarea>

              <div class="anam-row">
                <strong>Head & Neck</strong>
                <label><input type="checkbox" name="ros_head_headache" /> Headache</label>
                <label><input type="checkbox" name="ros_head_dizziness" /> Dizziness</label>
                <label><input type="checkbox" name="ros_head_speech" /> Speech problems</label>
                <label><input type="checkbox" name="ros_head_visual" /> Visual problems</label>
                <label><input type="checkbox" name="ros_head_ear" /> Ear pain</label>
                <label><input type="checkbox" name="ros_head_throat" /> Sore throat</label>
              </div>
              <textarea name="ros_head_notes" placeholder="Head & Neck - Other/Notes"></textarea>

              <div class="anam-row">
                <strong>Cardiovascular</strong>
                <label><input type="checkbox" name="ros_cardio_chest_pain" /> Chest pain</label>
                <label><input type="checkbox" name="ros_cardio_palpitations" /> Palpitations</label>
                <label><input type="checkbox" name="ros_cardio_doe" /> Dyspnea on exertion</label>
                <label><input type="checkbox" name="ros_cardio_mi" /> History of MI</label>
              </div>
              <textarea name="ros_cardio_notes" placeholder="Cardiovascular - Other/Notes"></textarea>

              <div class="anam-row">
                <strong>Respiratory</strong>
                <label><input type="checkbox" name="ros_resp_dyspnea" /> Dyspnea</label>
                <label><input type="checkbox" name="ros_resp_cough" /> Cough</label>
                <label><input type="checkbox" name="ros_resp_productive" /> Productive cough</label>
                <label><input type="checkbox" name="ros_resp_hemoptysis" /> Hemoptysis</label>
              </div>
              <textarea name="ros_resp_notes" placeholder="Respiratory - Other/Notes"></textarea>

              <div class="anam-row">
                <strong>Gastrointestinal</strong>
                <label><input type="checkbox" name="ros_gi_dysphagia" /> Dysphagia</label>
                <label><input type="checkbox" name="ros_gi_nausea" /> Nausea</label>
                <label><input type="checkbox" name="ros_gi_vomiting" /> Vomiting</label>
                <label><input type="checkbox" name="ros_gi_abd_pain" /> Abdominal pain</label>
                <label><input type="checkbox" name="ros_gi_diarrhea" /> Diarrhea</label>
                <label><input type="checkbox" name="ros_gi_constipation" /> Constipation</label>
                <label><input type="checkbox" name="ros_gi_blood_stool" /> Blood in stool</label>
              </div>
              <textarea name="ros_gi_notes" placeholder="Gastrointestinal - Other/Notes"></textarea>

              <div class="anam-row">
                <strong>Genitourinary</strong>
                <label><input type="checkbox" name="ros_gu_dysuria" /> Dysuria</label>
                <label><input type="checkbox" name="ros_gu_frequency" /> Frequency</label>
                <label><input type="checkbox" name="ros_gu_nocturia" /> Nocturia</label>
                <label><input type="checkbox" name="ros_gu_incontinence" /> Incontinence</label>
                <label><input type="checkbox" name="ros_gu_pain_urination" /> Pain on urination</label>
              </div>
              <textarea name="ros_gu_notes" placeholder="Genitourinary - Other/Notes"></textarea>
            </div>

            <div class="anam-section">
              <h3>5. Past Medical History</h3>
              <div class="anam-grid">
                <div>
                  <strong>Hypertension</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_htn" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_htn" value="no" /> No</label>
                  </div>
                  <input name="pmh_htn_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Diabetes mellitus</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_dm" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_dm" value="no" /> No</label>
                  </div>
                  <input name="pmh_dm_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Dyslipidemia</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_dyslip" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_dyslip" value="no" /> No</label>
                  </div>
                  <input name="pmh_dyslip_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Ischemic heart disease / CAD</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_cad" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_cad" value="no" /> No</label>
                  </div>
                  <input name="pmh_cad_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Chronic heart failure</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_chf" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_chf" value="no" /> No</label>
                  </div>
                  <input name="pmh_chf_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Chronic kidney disease</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_ckd" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_ckd" value="no" /> No</label>
                  </div>
                  <input name="pmh_ckd_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Chronic lung disease (COPD / asthma)</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_copd" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_copd" value="no" /> No</label>
                  </div>
                  <input name="pmh_copd_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Thyroid disease (hypo / hyper)</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_thyroid" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_thyroid" value="no" /> No</label>
                  </div>
                  <input name="pmh_thyroid_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Chronic liver disease</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_liver" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_liver" value="no" /> No</label>
                  </div>
                  <input name="pmh_liver_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Other chronic diseases</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="pmh_other" value="yes" /> Yes</label>
                    <label><input type="radio" name="pmh_other" value="no" /> No</label>
                  </div>
                  <input name="pmh_other_notes" placeholder="Notes" />
                </div>
              </div>
              <textarea name="pmh_notes" placeholder="Notes"></textarea>
              <div style="margin-top:8px">
                <strong>Specialist Care</strong>
                <div class="anam-row">
                  <label><input type="radio" name="pmh_specialist" value="no" /> No</label>
                  <label><input type="radio" name="pmh_specialist" value="yes" /> Yes</label>
                  <label><input type="checkbox" name="pmh_spec_cardiologist" /> Cardiologist</label>
                  <label><input type="checkbox" name="pmh_spec_diabetologist" /> Diabetologist</label>
                  <label><input type="checkbox" name="pmh_spec_endocrinologist" /> Endocrinologist</label>
                  <label><input type="checkbox" name="pmh_spec_nephrologist" /> Nephrologist</label>
                  <label><input type="checkbox" name="pmh_spec_pulmonologist" /> Pulmonologist</label>
                  <label><input type="checkbox" name="pmh_spec_gastro" /> Gastroenterologist</label>
                  <label><input type="checkbox" name="pmh_spec_neuro" /> Neurologist</label>
                  <label><input type="checkbox" name="pmh_spec_rheum" /> Rheumatologist</label>
                  <label><input type="checkbox" name="pmh_spec_onco" /> Oncologist</label>
                  <label><input type="checkbox" name="pmh_spec_urologist" /> Urologist</label>
                  <label><input type="checkbox" name="pmh_spec_gyn" /> Gynaecologist</label>
                  <label><input type="checkbox" name="pmh_spec_psych" /> Psychiatrist</label>
                  <input name="pmh_spec_other" placeholder="Other" />
                </div>
              </div>
              <div style="margin-top:8px">
                <strong>Operations & Hospitalizations</strong>
                <textarea name="pmh_operations" placeholder="Date - Procedure/Diagnosis - Outcome"></textarea>
                <div class="anam-row">
                  <span>Planned operation now</span>
                  <label><input type="radio" name="pmh_planned_op" value="yes" /> Yes</label>
                  <label><input type="radio" name="pmh_planned_op" value="no" /> No</label>
                  <input name="pmh_planned_op_details" placeholder="If yes, details" />
                </div>
              </div>
              <div style="margin-top:8px">
                <strong>Previous Examinations</strong>
                <div class="anam-row">
                  <label><input type="checkbox" name="pmh_exam_ecg" /> ECG</label>
                  <label><input type="checkbox" name="pmh_exam_blood" /> Blood tests</label>
                  <label><input type="checkbox" name="pmh_exam_ultrasound" /> Ultrasound</label>
                  <label><input type="checkbox" name="pmh_exam_ct" /> CT</label>
                  <label><input type="checkbox" name="pmh_exam_mri" /> MRI</label>
                  <input name="pmh_exam_other" placeholder="Other" />
                </div>
              </div>
            </div>

            <div class="anam-section">
              <h3>6. Allergies & Transfusions</h3>
              <textarea name="allergies" placeholder="Allergy / Reaction"></textarea>
              <div class="anam-row">
                <span>Blood transfusion in past</span>
                <label><input type="radio" name="blood_transfusion" value="no" /> No</label>
                <label><input type="radio" name="blood_transfusion" value="yes" /> Yes</label>
                <input name="blood_transfusion_number" placeholder="Number" />
                <span>Reaction</span>
                <label><input type="radio" name="blood_transfusion_reaction" value="no" /> No</label>
                <label><input type="radio" name="blood_transfusion_reaction" value="yes" /> Yes</label>
                <input name="blood_transfusion_reaction_desc" placeholder="Reaction details" />
              </div>
            </div>
            <div class="anam-section">
              <h3>7. Medication</h3>
              <textarea name="medication_list" placeholder="Drug - Dose - Frequency - Indication"></textarea>
              <div class="anam-row">
                <label><input type="radio" name="med_otc" value="no" /> No OTC drugs</label>
                <label><input type="radio" name="med_otc" value="yes" /> OTC drugs</label>
                <input name="med_otc_details" placeholder="If yes, which" />
              </div>
              <div class="anam-row">
                <label><input type="radio" name="med_supplements" value="no" /> No supplements</label>
                <label><input type="radio" name="med_supplements" value="yes" /> Supplements / vitamins / herbal</label>
                <input name="med_supplements_details" placeholder="If yes, which" />
              </div>
              <div class="anam-row">
                <span>History of misuse of prescribed drugs</span>
                <label><input type="radio" name="med_misuse" value="yes" /> Yes</label>
                <label><input type="radio" name="med_misuse" value="no" /> No</label>
                <input name="med_misuse_notes" placeholder="Notes" />
              </div>
            </div>

            <div class="anam-section">
              <h3>8. Gynecological History (Females)</h3>
              <div class="anam-grid">
                <div>
                  <strong>Regular menstruation</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_regular_menses" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_regular_menses" value="no" /> No</label>
                  </div>
                  <input name="gyn_regular_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Menopause</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_menopause" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_menopause" value="no" /> No</label>
                  </div>
                  <input name="gyn_menopause_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Contraception</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_contraception" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_contraception" value="no" /> No</label>
                  </div>
                  <input name="gyn_contraception_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Children</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_children" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_children" value="no" /> No</label>
                  </div>
                  <input name="gyn_children_number" placeholder="If yes, number" />
                </div>
                <div>
                  <strong>Deliveries</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_deliveries" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_deliveries" value="no" /> No</label>
                    <label><input type="checkbox" name="gyn_deliveries_vaginal" /> Vaginal</label>
                    <label><input type="checkbox" name="gyn_deliveries_csection" /> C-section</label>
                  </div>
                  <input name="gyn_deliveries_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Miscarriage / abortion</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_miscarriage" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_miscarriage" value="no" /> No</label>
                  </div>
                  <input name="gyn_miscarriage_number" placeholder="If yes, number" />
                </div>
                <div>
                  <strong>Pelvic pain</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="gyn_pelvic_pain" value="yes" /> Yes</label>
                    <label><input type="radio" name="gyn_pelvic_pain" value="no" /> No</label>
                  </div>
                  <input name="gyn_pelvic_pain_notes" placeholder="Notes" />
                </div>
              </div>
            </div>

            <div class="anam-section">
              <h3>9. Family History</h3>
              <textarea name="family_history_details" placeholder="Disease - Type - Relation"></textarea>
              <div class="anam-row">
                <span>Parents alive</span>
                <label><input type="checkbox" name="family_parents_both" /> Both</label>
                <label><input type="checkbox" name="family_parents_one" /> One</label>
                <label><input type="checkbox" name="family_parents_none" /> None</label>
                <input name="family_mother_cause" placeholder="Mother cause of death" />
                <input name="family_father_cause" placeholder="Father cause of death" />
              </div>
            </div>
            <div class="anam-section">
              <h3>10. Epidemiological History</h3>
              <div class="anam-row">
                <label><input type="checkbox" name="epi_travel" /> Recent travel abroad (12 months)</label>
                <input name="epi_travel_where" placeholder="Where" />
                <label><input type="checkbox" name="epi_pets" /> Pets / farm animals</label>
                <input name="epi_pets_which" placeholder="Which" />
              </div>
              <div class="anam-row">
                <label><input type="checkbox" name="epi_covid_vax" /> COVID-19 vaccination</label>
                <input name="epi_covid_vax_number" placeholder="Number" />
                <label><input type="checkbox" name="epi_covid_infection" /> COVID-19 infection</label>
                <input name="epi_covid_infection_number" placeholder="Number" />
              </div>
              <textarea name="epi_notes" placeholder="Notes"></textarea>
            </div>

            <div class="anam-section">
              <h3>11. Social History</h3>
              <div class="anam-row">
                <span>Employment</span>
                <label><input type="checkbox" name="social_working" /> Working</label>
                <label><input type="checkbox" name="social_retired" /> Retired</label>
                <label><input type="checkbox" name="social_unemployed" /> Unemployed</label>
                <input name="social_unemployed_how_long" placeholder="How long" />
              </div>
              <input name="social_occupation" placeholder="Occupation / previous jobs" />
              <div class="anam-row">
                <span>Marital status</span>
                <label><input type="checkbox" name="social_single" /> Single</label>
                <label><input type="checkbox" name="social_married" /> Married</label>
                <label><input type="checkbox" name="social_divorced" /> Divorced</label>
                <label><input type="checkbox" name="social_widowed" /> Widowed</label>
              </div>
              <div class="anam-row">
                <span>Living situation</span>
                <label><input type="checkbox" name="social_alone" /> Alone</label>
                <label><input type="checkbox" name="social_family" /> With family</label>
                <input name="social_other" placeholder="Other" />
              </div>
              <div class="anam-row">
                <span>Housing</span>
                <label><input type="checkbox" name="social_house" /> House</label>
                <label><input type="checkbox" name="social_apartment" /> Apartment</label>
                <input name="social_apartment_floor" placeholder="Which floor" />
                <label><input type="checkbox" name="social_elevator_yes" /> Elevator yes</label>
                <label><input type="checkbox" name="social_elevator_no" /> Elevator no</label>
                <label><input type="checkbox" name="social_homeless" /> Homeless</label>
              </div>
              <textarea name="social_notes" placeholder="Notes"></textarea>
            </div>

            <div class="anam-section">
              <h3>12. Abuses</h3>
              <div class="anam-grid">
                <div>
                  <strong>Smoking</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="abuse_smoking" value="yes" /> Yes</label>
                    <label><input type="radio" name="abuse_smoking" value="no" /> No</label>
                  </div>
                  <input name="abuse_smoking_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Alcohol</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="abuse_alcohol" value="yes" /> Yes</label>
                    <label><input type="radio" name="abuse_alcohol" value="no" /> No</label>
                  </div>
                  <input name="abuse_alcohol_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Coffee</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="abuse_coffee" value="yes" /> Yes</label>
                    <label><input type="radio" name="abuse_coffee" value="no" /> No</label>
                  </div>
                  <input name="abuse_coffee_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Black tea</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="abuse_black_tea" value="yes" /> Yes</label>
                    <label><input type="radio" name="abuse_black_tea" value="no" /> No</label>
                  </div>
                  <input name="abuse_black_tea_notes" placeholder="Notes" />
                </div>
                <div>
                  <strong>Drugs</strong>
                  <div class="anam-row">
                    <label><input type="radio" name="abuse_drugs" value="yes" /> Yes</label>
                    <label><input type="radio" name="abuse_drugs" value="no" /> No</label>
                  </div>
                  <input name="abuse_drugs_notes" placeholder="Notes" />
                </div>
              </div>
              <textarea name="abuse_notes" placeholder="Notes"></textarea>
            </div>
            <div class="anam-section">
              <h3>13. Status Praesens Generalis (SPG)</h3>
              <div class="anam-row">
                <span>Consciousness</span>
                <label><input type="checkbox" name="spg_alert" /> Alert</label>
                <label><input type="checkbox" name="spg_responsive" /> Responsive</label>
                <label><input type="checkbox" name="spg_lethargic" /> Lethargic</label>
                <label><input type="checkbox" name="spg_nonresponsive" /> Non-responsive</label>
              </div>
              <div class="anam-row">
                <span>Orientation</span>
                <label><input type="checkbox" name="spg_orientation_person" /> Person</label>
                <label><input type="checkbox" name="spg_orientation_place" /> Place</label>
                <label><input type="checkbox" name="spg_orientation_time" /> Time</label>
              </div>
              <div class="anam-row">
                <span>General appearance</span>
                <label><input type="checkbox" name="spg_calm" /> Calm</label>
                <label><input type="checkbox" name="spg_distressed" /> Distressed</label>
                <label><input type="checkbox" name="spg_pain" /> In pain</label>
                <label><input type="checkbox" name="spg_dyspneic" /> Dyspneic</label>
                <label><input type="checkbox" name="spg_cachectic" /> Cachectic</label>
              </div>
              <div class="anam-row">
                <span>Hydration</span>
                <label><input type="checkbox" name="spg_hydration_normal" /> Normal</label>
                <label><input type="checkbox" name="spg_hydration_mild" /> Mild dehydration</label>
                <label><input type="checkbox" name="spg_hydration_moderate" /> Moderate</label>
                <label><input type="checkbox" name="spg_hydration_severe" /> Severe</label>
              </div>
              <div class="anam-row">
                <span>Nutrition status</span>
                <label><input type="checkbox" name="spg_nutrition_normal" /> Normal</label>
                <label><input type="checkbox" name="spg_nutrition_under" /> Underweight</label>
                <label><input type="checkbox" name="spg_nutrition_over" /> Overweight</label>
                <label><input type="checkbox" name="spg_nutrition_obese" /> Obese</label>
              </div>
              <div class="anam-row">
                <span>Habitus</span>
                <label><input type="checkbox" name="spg_habitus_asthenic" /> Asthenic</label>
                <label><input type="checkbox" name="spg_habitus_normo" /> Normosthenic</label>
                <label><input type="checkbox" name="spg_habitus_hyper" /> Hypersthenic</label>
              </div>
              <div class="anam-row">
                <span>Gait / mobility</span>
                <label><input type="checkbox" name="spg_gait_normal" /> Normal</label>
                <label><input type="checkbox" name="spg_gait_ataxic" /> Ataxic</label>
                <label><input type="checkbox" name="spg_gait_hemi" /> Hemiparetic</label>
                <label><input type="checkbox" name="spg_gait_shuffling" /> Shuffling</label>
                <label><input type="checkbox" name="spg_gait_aid" /> Uses aid</label>
              </div>
              <input name="spg_gait_aid_type" placeholder="Aid (cane / walker / wheelchair)" />
              <div class="anam-row">
                <span>Speech</span>
                <label><input type="checkbox" name="spg_speech_normal" /> Normal</label>
                <label><input type="checkbox" name="spg_speech_dysarthria" /> Dysarthria</label>
                <label><input type="checkbox" name="spg_speech_aphasia" /> Aphasia</label>
                <label><input type="checkbox" name="spg_speech_slurred" /> Slurred</label>
              </div>
              <div class="anam-row">
                <span>Position</span>
                <label><input type="checkbox" name="spg_position_active" /> Active</label>
                <label><input type="checkbox" name="spg_position_passive" /> Passive</label>
                <label><input type="checkbox" name="spg_position_forced" /> Forced</label>
              </div>
              <div class="anam-row">
                <span>Skin</span>
                <label><input type="checkbox" name="spg_skin_rashes" /> Rashes</label>
                <label><input type="checkbox" name="spg_skin_lesions" /> Lesions</label>
                <label><input type="checkbox" name="spg_skin_scars" /> Scars</label>
                <label><input type="checkbox" name="spg_skin_icterus" /> Icterus</label>
                <label><input type="checkbox" name="spg_skin_cyanosis" /> Cyanosis</label>
                <label><input type="checkbox" name="spg_skin_pallor" /> Pallor</label>
              </div>
              <textarea name="spg_skin_notes" placeholder="Skin notes"></textarea>
              <div class="anam-row">
                <span>Peripheral edema</span>
                <label><input type="checkbox" name="spg_edema_none" /> None</label>
                <label><input type="checkbox" name="spg_edema_mild" /> Mild</label>
                <label><input type="checkbox" name="spg_edema_moderate" /> Moderate</label>
                <label><input type="checkbox" name="spg_edema_severe" /> Severe</label>
                <label><input type="checkbox" name="spg_edema_pretibial" /> Pretibial</label>
                <label><input type="checkbox" name="spg_edema_sacral" /> Sacral</label>
              </div>
              <div class="anam-row">
                <span>Odor</span>
                <label><input type="checkbox" name="spg_odor_alcohol" /> Alcohol</label>
                <label><input type="checkbox" name="spg_odor_ketosis" /> Ketosis</label>
                <label><input type="checkbox" name="spg_odor_uremic" /> Uremic</label>
                <label><input type="checkbox" name="spg_odor_hepatic" /> Hepatic</label>
                <input name="spg_odor_other" placeholder="Other" />
              </div>
            </div>

            <div class="anam-section">
              <h3>14. Vital Signs and Values (Adult)</h3>
              <div class="anam-grid">
                <input name="vital_temp" placeholder="Temperature (C)" />
                <input name="vital_spo2" placeholder="SpO2 (%)" />
                <input name="vital_hr" placeholder="Heart rate (/min)" />
                <input name="vital_weight" placeholder="Weight (kg)" />
                <input name="vital_rr" placeholder="Respiratory rate (/min)" />
                <input name="vital_height" placeholder="Height (cm)" />
                <input name="vital_bp" placeholder="Blood pressure (mmHg)" />
                <input name="vital_bmi" placeholder="BMI (kg/m2)" />
              </div>
              <div class="anam-row">
                <span>Taken</span>
                <label><input type="checkbox" name="vital_taken_monitor" /> From monitor</label>
                <label><input type="checkbox" name="vital_taken_chart" /> From Pt. charts</label>
                <input name="vital_taken_when" placeholder="If from charts, when" />
              </div>
              <textarea name="vital_notes" placeholder="Notes"></textarea>
            </div>

            <div class="anam-section">
              <h3>15. Status Praesens Localis (SPL)</h3>
              <strong>Medical Devices / Lines / Catheters</strong>
              <div class="anam-grid">
                <div>
                  <span>Peripheral IV line</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_iv" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_iv" value="no" /> No</label>
                  </div>
                  <input name="spl_iv_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>Central venous catheter</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_cvc" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_cvc" value="no" /> No</label>
                  </div>
                  <input name="spl_cvc_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>Foley catheter</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_foley" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_foley" value="no" /> No</label>
                  </div>
                  <input name="spl_foley_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>Drains</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_drains" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_drains" value="no" /> No</label>
                  </div>
                  <input name="spl_drains_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>Oxygen therapy</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_o2" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_o2" value="no" /> No</label>
                  </div>
                  <input name="spl_o2_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>ECG monitoring</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_ecg" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_ecg" value="no" /> No</label>
                  </div>
                  <input name="spl_ecg_notes" placeholder="Notes" />
                </div>
                <div>
                  <span>Vital function monitor</span>
                  <div class="anam-row">
                    <label><input type="radio" name="spl_vital_monitor" value="yes" /> Yes</label>
                    <label><input type="radio" name="spl_vital_monitor" value="no" /> No</label>
                  </div>
                  <input name="spl_vital_monitor_notes" placeholder="Notes" />
                </div>
              </div>
              <textarea name="spl_notes" placeholder="Notes"></textarea>

              <div style="margin-top:10px">
                <strong>Head</strong>
                <textarea name="spl_head_notes" placeholder="Face symmetry, scalp & hair, cranial nerves, eyes, ears & nose, mouth & pharynx"></textarea>
              </div>
              <div style="margin-top:10px">
                <strong>Neck</strong>
                <textarea name="spl_neck_notes" placeholder="Lymph nodes, thyroid, trachea, JVP, carotids, mobility"></textarea>
              </div>
              <div style="margin-top:10px">
                <strong>Thorax</strong>
                <textarea name="spl_thorax_notes" placeholder="Chest, lungs, heart"></textarea>
              </div>
              <div style="margin-top:10px">
                <strong>Abdomen</strong>
                <textarea name="spl_abdomen_notes" placeholder="Inspection, palpation, percussion, auscultation, special signs"></textarea>
              </div>
              <div style="margin-top:10px">
                <strong>Limbs</strong>
                <textarea name="spl_limbs_notes" placeholder="Inspection, skin changes, mobility, joints, pulses"></textarea>
              </div>
              <div style="margin-top:10px">
                <strong>Spine</strong>
                <textarea name="spl_spine_notes" placeholder="Posture, curvature, mobility"></textarea>
              </div>
            </div>
            <details class="anam-section">
              <summary><strong>16. Reference values</strong></summary>
              <table class="anam-table">
                <thead>
                  <tr>
                    <th>Parameter</th>
                    <th>Male</th>
                    <th>Female</th>
                    <th>Units</th>
                    <th>Pt. values</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>Hemoglobin (Hb)</td><td>135-175</td><td>120-155</td><td>g/L</td><td><input name="ref_hb" /></td></tr>
                  <tr><td>Red blood cells (RBC)</td><td>4.5-5.9</td><td>4.0-5.2</td><td>x10^12/L</td><td><input name="ref_rbc" /></td></tr>
                  <tr><td>Hematocrit (Hct)</td><td>0.40-0.52</td><td>0.36-0.46</td><td>L/L</td><td><input name="ref_hct" /></td></tr>
                  <tr><td>White blood cells (WBC)</td><td>4.0-10.0</td><td>4.0-10.0</td><td>x10^9/L</td><td><input name="ref_wbc" /></td></tr>
                  <tr><td>Platelets (PLT)</td><td>150-400</td><td>150-400</td><td>x10^9/L</td><td><input name="ref_plt" /></td></tr>
                  <tr><td>C-reactive protein (CRP)</td><td>&lt; 5</td><td>&lt; 5</td><td>mg/L</td><td><input name="ref_crp" /></td></tr>
                  <tr><td>Creatinine</td><td>64-104</td><td>49-90</td><td>umol/L</td><td><input name="ref_crea" /></td></tr>
                  <tr><td>Urea</td><td>2.5-7.8</td><td>2.5-7.8</td><td>mmol/L</td><td><input name="ref_urea" /></td></tr>
                  <tr><td>Sodium (Na)</td><td>135-145</td><td>135-145</td><td>mmol/L</td><td><input name="ref_na" /></td></tr>
                  <tr><td>Potassium (K)</td><td>3.5-5.1</td><td>3.5-5.1</td><td>mmol/L</td><td><input name="ref_k" /></td></tr>
                  <tr><td>Chloride (Cl)</td><td>98-107</td><td>98-107</td><td>mmol/L</td><td><input name="ref_cl" /></td></tr>
                  <tr><td>Calcium (total)</td><td>2.15-2.55</td><td>2.15-2.55</td><td>mmol/L</td><td><input name="ref_ca" /></td></tr>
                  <tr><td>ALT</td><td>&lt; 50</td><td>&lt; 35</td><td>U/L</td><td><input name="ref_alt" /></td></tr>
                  <tr><td>AST</td><td>&lt; 50</td><td>&lt; 35</td><td>U/L</td><td><input name="ref_ast" /></td></tr>
                  <tr><td>Bilirubin - total</td><td>5-21</td><td>5-21</td><td>umol/L</td><td><input name="ref_bili_total" /></td></tr>
                  <tr><td>Bilirubin - direct</td><td>&lt; 5</td><td>&lt; 5</td><td>umol/L</td><td><input name="ref_bili_direct" /></td></tr>
                  <tr><td>Bilirubin - indirect</td><td>3-17</td><td>3-17</td><td>umol/L</td><td><input name="ref_bili_indirect" /></td></tr>
                  <tr><td>Fasting glucose</td><td>3.9-5.5</td><td>3.9-5.5</td><td>mmol/L</td><td><input name="ref_glucose" /></td></tr>
                  <tr><td>Total cholesterol</td><td>&lt; 5.0</td><td>&lt; 5.0</td><td>mmol/L</td><td><input name="ref_chol_total" /></td></tr>
                  <tr><td>LDL cholesterol</td><td>&lt; 3.0</td><td>&lt; 3.0</td><td>mmol/L</td><td><input name="ref_ldl" /></td></tr>
                  <tr><td>HDL cholesterol</td><td>&gt; 1.0</td><td>&gt; 1.2</td><td>mmol/L</td><td><input name="ref_hdl" /></td></tr>
                  <tr><td>Triglycerides</td><td>&lt; 1.7</td><td>&lt; 1.7</td><td>mmol/L</td><td><input name="ref_trig" /></td></tr>
                  <tr><td>TSH</td><td>0.4-4.0</td><td>0.4-4.0</td><td>mIU/L</td><td><input name="ref_tsh" /></td></tr>
                </tbody>
              </table>
            </details>
          </form>
          <div class="row" style="margin-top:12px">
            <button type="button" id="anamnesis-clear" class="danger">Clear form</button>
            <button type="button" id="anamnesis-back" data-i18n="back">Back</button>
          </div>
          <p id="anamnesis-status" class="muted"></p>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://glrxzhmhgzhabqzhmsiu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdscnh6aG1oZ3poYWJxemhtc2l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzM3NzUsImV4cCI6MjA4MjQwOTc3NX0.Nzx3cHnPpn1awhQyNhjwKd2GUFnzieVR6uz7L-2eKrs";




// --- DOM helpers (prevents crashes if an element is missing) ---
const $ = (id)=>document.getElementById(id);
const on = (id, ev, fn)=>{ const el=$(id); if(!el){ console.warn('Missing element:', id); return; } el.addEventListener(ev, fn); };
// ===== Supabase Storage: base CSV files for offline cache =====
// Bucket name must match your Supabase Storage bucket exactly
const STORAGE_BUCKET = "Medical terms CSV";
const STORAGE_FILES = [
  { filename: "medical_terms.csv", cacheId: "base/medical_terms.csv" },
  { filename: "App translations.csv", cacheId: "base/App translations.csv" },
  { filename: "muscles.csv", cacheId: "base/muscles.csv" },
];
let supabase = null;

function initSupabase() {
  if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("PASTE_")) {
    console.warn("Supabase anon key missing – running local-only mode");
    return null;
  }
  if (!supabase) {
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
  return supabase;
}


// ===== Offline cache via IndexedDB (stores downloaded CSVs) =====
const IDB_NAME = "mdict_cache";
const IDB_STORE = "files";
const IDB_VERSION = 1;

function idbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(IDB_NAME, IDB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(IDB_STORE)){
        db.createObjectStore(IDB_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbGet(key){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, "readonly");
    const store = tx.objectStore(IDB_STORE);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

async function idbSet(key, value){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, "readwrite");
    const store = tx.objectStore(IDB_STORE);
    const req = store.put(value, key);
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
}

// ===== Supabase Storage helpers (download base CSVs) =====
function storageClient(){
  const c = initSupabase();
  if(!c) return null;
  return c.storage.from(STORAGE_BUCKET);
}

async function storageListMeta(){
  const sc = storageClient();
  if(!sc) return null;
  try{
    const { data, error } = await sc.list("", { limit: 1000 });
    if(error) throw error;

    const meta = {};
    for(const f of (data || [])){
      meta[f.name] = f;
    }
    return meta;
  }catch(e){
    console.warn("Storage list failed (will fall back to direct downloads):", e.message || e);
    return null;
  }
}

async function downloadFromStorage(filename){
  const sc = storageClient();
  if(!sc) throw new Error("Supabase not configured");
  const { data, error } = await sc.download(filename);
  if(error) throw error;
  return await data.text();
}

/**
 * Refresh cached base CSV files on login.
 * - Downloads files from Supabase Storage to IndexedDB if remote updated_at changed.
 */
async function refreshBaseFilesCache(){
  // Goal: ensure the newest CSVs are available on every page load.
  // Strategy:
  // 1) Try list() to get updated_at and avoid unnecessary downloads
  // 2) If list() fails (private bucket / RLS / CORS), fall back to direct download for each file
  const meta = await storageListMeta();

  for(const f of STORAGE_FILES){
    const cacheKey = "file:" + f.cacheId;
    let cached = null;

    try{ cached = await idbGet(cacheKey); }catch(e){ cached = null; }

    const remote = meta ? meta[f.filename] : null;
    const remoteUpdated = remote?.updated_at || remote?.created_at || null;
    const cachedUpdated = cached?.updated_at || null;

    // If we can't read remoteUpdated (meta missing), force a download attempt.
    const needsUpdate = !meta || !cached || !cachedUpdated || (remoteUpdated && remoteUpdated !== cachedUpdated);

    if(needsUpdate){
      try{
        const text = await downloadFromStorage(f.filename);
        await idbSet(cacheKey, {
          text,
          updated_at: remoteUpdated,      // may be null; that's ok
          filename: f.filename,
          saved_at: new Date().toISOString()
        });
      }catch(e){
        console.warn("Storage download failed for", f.filename, "(continuing):", e.message || e);
      }
    }
  }
}

/**
 * Load base CSV:
 * 1) IndexedDB cache (if present)
 * 2) local file (fallback)
 */
async function loadBaseFile(filename){
  const entry = STORAGE_FILES.find(x => x.filename === filename);
  const cacheKey = "file:" + (entry ? entry.cacheId : ("base/" + filename));

  const cached = await idbGet(cacheKey);
  if(cached?.text) return cached.text;

  return await loadFile(filename);
}


function setLoginStatus(text, type = "info") {
  const el = document.getElementById("login-status");
  if (!el) return;

  el.textContent = String(text || "");
  el.style.display = "block";

  el.style.background =
    type === "ok" ? "#eafaf0" :
    type === "error" ? "#fde8e8" :
    "#ecfdf5";
}

function clearLoginStatus(){
  const el = document.getElementById("login-status");
  if(!el) return;
  el.style.display = "none";
  el.textContent = "";
  el.style.background = "";
}

function normalizeLoginIdentifier(input){
  const raw = String(input || "").trim().toLowerCase();
  if(!raw) return "";
  if(raw.includes("@")) return raw;
  return raw + "@medicaldict.local";
}

async function supaGetSession(){
  const c = initSupabase();
  if(!c) return null;
  const { data, error } = await c.auth.getSession();
  if(error) throw error;
  return data.session;
}

async function supaSignUp(email, password, displayName){
  const c = initSupabase();
  if(!c) throw new Error("Supabase not configured");
  const { error } = await c.auth.signUp({
    email,
    password,
    options: { data: { name: displayName || "" } }
  });
  if(error) throw error;
}

async function supaSignIn(email, password){
  const c = initSupabase();
  if(!c) throw new Error("Supabase not configured");
  const { error } = await c.auth.signInWithPassword({ email, password });
  if(error) throw error;
}

async function supaRequestPasswordReset(email){
  const c = initSupabase();
  if(!c) throw new Error("Supabase not configured");
  const base = window.location.origin + window.location.pathname.replace(/[^/]*$/, "");
  const redirectTo = base + "reset-password.html";
  const { error } = await c.auth.resetPasswordForEmail(email, { redirectTo });
  if(error) throw error;
}

async function supaSignOut(){
  const c = initSupabase();
  if(!c) return;
  const { error } = await c.auth.signOut();
  if(error) throw error;
}

// -------- Supabase schema (Option B: normalized tables) --------
const USER_TERMS_TABLE = "user_terms";
const USER_REVIEW_TABLE = "user_review";

// -------- Offline cache (localStorage) --------
function cacheKeyTerms(){ return "cache/user_terms"; }
function cacheKeyReview(){ return "cache/user_review"; }

function readJsonLS(key, fallback){
  try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }
  catch(e){ return fallback; }
}
function writeJsonLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function getLocalTerms(){ return readJsonLS(cacheKeyTerms(), []); }
function setLocalTerms(terms){ writeJsonLS(cacheKeyTerms(), terms || []); updateDirtyCount(); }

function getLocalReview(){ return readJsonLS(cacheKeyReview(), []); }
function setLocalReview(items){ writeJsonLS(cacheKeyReview(), items || []); updateDirtyCount(); }

function cacheKeyUserMap(){ return "cache/user_display_map"; }
function getLocalUserMap(){ return readJsonLS(cacheKeyUserMap(), []); }
function setLocalUserMap(items){ writeJsonLS(cacheKeyUserMap(), items || []); }
function setDisplayNameMapping(name, email){
  if(!name || !email) return;
  const map = getLocalUserMap();
  const key = name.trim().toLowerCase();
  const existing = map.find(x => (x.name || '').toLowerCase() === key);
  if(existing) existing.email = email;
  else map.push({ name, email });
  setLocalUserMap(map);
}
function lookupEmailByDisplayName(name){
  const key = String(name || '').trim().toLowerCase();
  if(!key) return '';
  const map = getLocalUserMap();
  const hit = map.find(x => (x.name || '').toLowerCase() === key);
  return hit ? hit.email : '';
}

function countDirty(){
  const t = getLocalTerms().filter(x=>x && x.dirty).length;
  const r = getLocalReview().filter(x=>x && x.dirty).length;
  return t + r;
}
function updateDirtyCount(){
  const el = document.getElementById("sync-dirty-count");
  if(el) el.textContent = String(countDirty());
}
function setSyncStatus(msg){
  const el = document.getElementById("sync-status");
  if(el) el.textContent = msg;
}

// -------- Supabase data access (normalized tables) --------
async function supaRequireSession(){
  const c = initSupabase();
  if(!c) throw new Error("Supabase not configured");
  const { data, error } = await c.auth.getSession();
  if(error) throw error;
  if(!data.session) throw new Error("Auth session missing");
  return { client: c, session: data.session };
}

async function supaFetchUserTerms(){
  const { client } = await supaRequireSession();
  const { data, error } = await client
    .from(USER_TERMS_TABLE)
    .select("*")
    .order("updated_at", { ascending: false });
  if(error) throw error;
  return data || [];
}

async function supaUpsertUserTerms(rows){
  const { client, session } = await supaRequireSession();
  const now = new Date().toISOString();
  const payload = (rows || []).map(r => ({
    id: r.id || undefined,
    user_id: session.user.id,
    english: r.english ?? null,
    german: r.german ?? null,
    latin: r.latin ?? null,
    slovak: r.slovak ?? null,
    spanish: r.spanish ?? null,
    source_dataset: r.source_dataset ?? null,
    notes: r.notes ?? null,
    created_at: r.created_at ?? undefined,
    updated_at: now
  }));
  if(payload.length === 0) return;
  const { error } = await client
    .from(USER_TERMS_TABLE)
    .upsert(payload, { onConflict: "id" });
  if(error) throw error;
}

async function supaFetchUserReview(){
  const { client } = await supaRequireSession();
  const { data, error } = await client
    .from(USER_REVIEW_TABLE)
    .select("*")
    .order("updated_at", { ascending: false });
  if(error) throw error;
  return data || [];
}

async function supaUpsertUserReview(rows){
  const { client, session } = await supaRequireSession();
  const now = new Date().toISOString();
  const payload = (rows || []).map(r => ({
    id: r.id || undefined,
    user_id: session.user.id,
    user_term_id: r.user_term_id ?? null,
    base_term_key: r.base_term_key ?? null,
    base_dataset: r.base_dataset ?? null,
    difficulty: Number.isFinite(r.difficulty) ? r.difficulty : 0,
    last_seen: r.last_seen ?? null,
    next_due: r.next_due ?? null,
    created_at: r.created_at ?? undefined,
    updated_at: now
  }));
  if(payload.length === 0) return;
  const { error } = await client
    .from(USER_REVIEW_TABLE)
    .upsert(payload, { onConflict: "id" });
  if(error) throw error;
}

// -------- Sync (manual) --------
function mergeById(localRows, remoteRows){
  const map = new Map();
  for(const r of (remoteRows||[])){
    if(r && r.id) map.set(r.id, { ...r, dirty: false });
  }
  for(const l of (localRows||[])){
    if(!l) continue;
    if(l.id){
      const existing = map.get(l.id);
      if(l.dirty) map.set(l.id, { ...(existing||{}), ...l, dirty: true });
      else if(!existing) map.set(l.id, { ...l, dirty: false });
    } else {
      map.set("local-" + Math.random().toString(16).slice(2), { ...l, dirty: true });
    }
  }
  return Array.from(map.values());
}

async function syncNow(){
  if(!state.currentUserEmail){ setSyncStatus("login required"); return; }
  try{
    setSyncStatus("syncing...");
    const [remoteTerms, remoteReview] = await Promise.all([supaFetchUserTerms(), supaFetchUserReview()]);
    const mergedTerms = mergeById(getLocalTerms(), remoteTerms);
    const mergedReview = mergeById(getLocalReview(), remoteReview);
    setLocalTerms(mergedTerms);
    setLocalReview(mergedReview);

    const dirtyTerms = mergedTerms.filter(x=>x && x.dirty);
    const dirtyReview = mergedReview.filter(x=>x && x.dirty);

    for(const t of dirtyTerms){
      if(!t.id) t.id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(16)+Math.random().toString(16).slice(2));
    }
    for(const r of dirtyReview){
      if(!r.id) r.id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(16)+Math.random().toString(16).slice(2));
    }

    await Promise.all([supaUpsertUserTerms(dirtyTerms), supaUpsertUserReview(dirtyReview)]);

    for(const t of mergedTerms) t.dirty = false;
    for(const r of mergedReview) r.dirty = false;
    setLocalTerms(mergedTerms);
    setLocalReview(mergedReview);

    localStorage.setItem("cache/last_sync_at", new Date().toISOString());
    setSyncStatus("synced " + new Date().toLocaleString());
  }catch(e){
    console.error(e);
    setSyncStatus("sync failed: " + (e.message || e));
  }
}

// --- Utilities: File loader that works with both http and file:// protocols ---
async function loadFile(filename) {
  try {
    const response = await fetch(filename);
    return await response.text();
  } catch (e) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', filename, true);
      xhr.onload = () => resolve(xhr.responseText);
      xhr.onerror = () => {
        try {
          const syncXhr = new XMLHttpRequest();
          syncXhr.open('GET', filename, false);
          syncXhr.send();
          if (syncXhr.status === 200) resolve(syncXhr.responseText);
          else reject(new Error(`Failed to load ${filename}`));
        } catch (finalError) {
          reject(finalError);
        }
      };
      xhr.send();
    });
  }
}

// --- Utilities: robust CSV parser for quoted fields (RFC4180-ish) ---
function parseCSVLines(text){
  const rows = [];
  let cur = [];
  let curField = '';
  let inQuotes = false;

  const firstLine = text.split(/\r?\n/, 1)[0] || '';
  const semiCount = (firstLine.match(/;/g) || []).length;
  const commaCount = (firstLine.match(/,/g) || []).length;
  const delimiter = semiCount > commaCount ? ';' : ',';

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];
    if(inQuotes){
      if(ch === '"'){
        if(next === '"'){ curField += '"'; i++; } else { inQuotes = false; }
      } else { curField += ch; }
    } else {
      if(ch === '"') { inQuotes = true; }
      else if(ch === delimiter){ cur.push(curField); curField = ''; }
      else if(ch === '\r') continue;
      else if(ch === '\n'){ cur.push(curField); rows.push(cur); cur = []; curField = ''; }
      else curField += ch;
    }
  }
  if(curField !== '' || cur.length>0) { cur.push(curField); rows.push(cur); }
  return rows;
}

function rowsToObjects(rows){
  if(!rows || rows.length === 0) return [];
  const headers = rows[0].map(h=>h.trim());
  const objs = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    const obj = {};
    for(let j=0;j<headers.length;j++) obj[headers[j]] = (row[j]||'').trim();
    objs.push(obj);
  }
  return objs;
}

// --- Translation loader ---
const translations = {};
async function loadTranslations(){
  try{
    const txt = await loadBaseFile('App translations.csv');
    const rows = parseCSVLines(txt);
    if(rows.length < 1) throw new Error('No data in translations file');

    Object.keys(translations).forEach(k => delete translations[k]);

    const headers = rows[0].map(h => h.trim());
    for(let i = 1; i < headers.length; i++) {
      const lang = headers[i];
      translations[lang] = {};
    }

    for(let i = 1; i < rows.length; i++) {
      const row = rows[i];
      const key = row[0].trim();
      if(!key) continue;

      for(let j = 1; j < headers.length; j++) {
        const lang = headers[j];
        const text = (row[j] || '').trim();
        if(text) translations[lang][key] = text;
      }
    }

    const variations = {
      'english': 'English',
      'deutch': 'Deutch',
      'deutsch': 'Deutch',
      'german': 'Deutch',
      'slovensky': 'Slovensky',
      'slovak': 'Slovensky',
      'espanol': 'Spanish',
      'español': 'Spanish',
      'spanish': 'Spanish',
      'norsk': 'Norwegian',
      'norwegian': 'Norwegian',
      'islenska': 'Icelandic',
      'íslenska': 'Icelandic',
      'icelandic': 'Icelandic'
    };
    Object.entries(variations).forEach(([variant, standard]) => {
      if(translations[standard]) translations[variant] = translations[standard];
    });
  }catch(e){
    console.warn('Translations load failed:', e.message);
  }
}

// --- Medical terms loader ---
let medicalTerms = [];
async function loadMedicalTerms() {
  try {
    const txt = await loadBaseFile('medical_terms.csv');
    const rows = parseCSVLines(txt);
    if(rows.length < 1) throw new Error('No data in medical terms file');
    medicalTerms = rowsToObjects(rows);
  } catch(e) {
    console.warn('Medical terms load failed:', e.message);
    medicalTerms = [];
  }
}

// --- Muscles loader ---
let muscleTerms = [];
async function loadMuscles() {
  try {
    const txt = await loadBaseFile('muscles.csv');
    const rows = parseCSVLines(txt);
    if(rows.length < 1) throw new Error('No data in muscles file');
    muscleTerms = rowsToObjects(rows);
  } catch(e) {
    console.warn('Muscles load failed:', e.message);
    muscleTerms = [];
  }
}

// --- UI wiring and i18n ---
let state = { language: localStorage.getItem('app_language') || 'English', currentUser: null, currentUserEmail: null };

// ===== Language handling =====
const LANG_CANON = {
  'english':'English',
  'deutch':'Deutch',
  'deutsch':'Deutch',
  'german':'Deutch',
  'slovensky':'Slovensky',
  'slovak':'Slovensky',
  'spanish':'Spanish',
  'espanol':'Spanish',
  'español':'Spanish',
  'norwegian':'Norwegian',
  'norsk':'Norwegian',
  'icelandic':'Icelandic',
  'islenska':'Icelandic',
  'íslenska':'Icelandic'
};

function normalizeLanguage(lang){
  const raw = String(lang || '').trim();
  if(!raw) return 'English';
  const key = raw.toLowerCase();
  return LANG_CANON[key] || raw;
}

function getBaseSearchField(){
  const lang = normalizeLanguage(state.language);
  // Map UI language -> base CSV column
  if(lang === 'Deutch') return 'german_translation';
  if(lang === 'Slovensky') return 'slovak_translation';
  if(lang === 'Spanish') return 'spanish_translation';
  // If you later add these columns to your base CSV, update mapping here
  if(lang === 'Norwegian') return 'norvegian_translation';
  if(lang === 'Icelandic') return 'icelandic_translation';
  return 'english_translation';
}

function getUserSearchField(){
  const lang = normalizeLanguage(state.language);
  // Map UI language -> user_terms object field
  if(lang === 'Deutch') return 'german';
  if(lang === 'Slovensky') return 'slovak';
  if(lang === 'Spanish') return 'spanish';
  if(lang === 'Norwegian') return 'norwegian';
  if(lang === 'Icelandic') return 'icelandic';
  return 'english';
}

const BASE_SEARCH_FIELDS = [
  "latin_translation",
  "english_translation",
  "german_translation",
  "slovak_translation",
  "spanish_translation",
  "norvegian_translation",
  "norwegian_translation",
  "icelandic_translation",
  "english_definition",
  "german_definition",
  "slovak_definition",
  "spanish_definition",
  "norwegian_definition",
  "icelandic_definition",
  "genitive",
  "accusative"
];

const USER_SEARCH_FIELDS = [
  "latin",
  "english",
  "german",
  "slovak",
  "spanish",
  "norwegian",
  "icelandic",
  "notes"
];

const USER_FIELD_MAP = {
  english_translation: "english",
  german_translation: "german",
  slovak_translation: "slovak",
  latin_translation: "latin",
  spanish_translation: "spanish",
  norwegian_translation: "norwegian",
  norvegian_translation: "norwegian",
  icelandic_translation: "icelandic"
};

function includesQuery(value, query){
  return String(value || "").toLowerCase().includes(query);
}

function matchAnyField(row, fields, query){
  for(const f of fields){
    if(includesQuery(row[f], query)) return true;
  }
  return false;
}

function mapUserFieldFromBase(baseField){
  return USER_FIELD_MAP[baseField] || baseField;
}

async function setLanguage(lang){
  const canonical = normalizeLanguage(lang);
  state.language = canonical;
  localStorage.setItem('app_language', canonical);

  const sel = document.getElementById('language');
  if(sel) sel.value = canonical;

  // Ensure translations are loaded at least once
  if(!translations || Object.keys(translations).length === 0){
    try{ await loadTranslations(); }catch(e){}
  }

  applyTranslationsToDom();

  // If user is currently searching, rerender results instantly
  const si = document.getElementById('search-input');
  if(si && si.value && si.value.trim().length >= 2){
    si.dispatchEvent(new Event('input', { bubbles:true }));
  }

  refreshMuscleTrainingUI();
}


function t(key){
  const lang = state.language;
  if(translations[lang] && translations[lang][key]) return translations[lang][key];
  if(translations['English'] && translations['English'][key]) return translations['English'][key];
  return key;
}

function applyTranslationsToDom(){
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    el.textContent = t(k);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const k = el.getAttribute('data-i18n-placeholder');
    el.placeholder = t(k);
  });
}

// --- Muscle training helpers ---
const MUSCLE_HIDDEN = "****";
const MUSCLE_SEARCH_FIELD_KEY = "muscle_search_field";
const ANAMNESIS_STORAGE_KEY = "anamnesis_form_v1";
const TEXT_SIZE_KEY = "text_size";
const TEXT_SIZES = [13,14,15,16,17,18,19];
let muscleQuizPool = [];
let muscleQuizCurrent = null;
let muscleQuizRevealed = false;
let muscleQuizSelectedRegions = new Set();
let muscleQuizSelectedCategories = new Set();
let muscleQuizPersistentFields = new Set();
let muscleQuizTempFields = new Set();

function getMuscleRegionField(){
  const lang = normalizeLanguage(state.language);
  if(lang === 'Deutch') return 'muscle_region_ge';
  if(lang === 'Slovensky') return 'muscle_region_sk';
  return 'muscle_region_en';
}

function getMuscleCategoryField(){
  const lang = normalizeLanguage(state.language);
  if(lang === 'Deutch') return 'muscle_category_ge';
  if(lang === 'Slovensky') return 'muscle_category_sk';
  return 'muscle_category_en';
}

function getMuscleRegionKey(row){
  return (row.muscle_region_en || row.muscle_region_sk || row.muscle_region_ge || '').trim();
}

function getMuscleCategoryKey(row){
  return (row.muscle_category_en || row.muscle_category_sk || row.muscle_category_ge || '').trim();
}

function getMuscleRegionLabel(row){
  const field = getMuscleRegionField();
  return (row[field] || row.muscle_region_en || row.muscle_region_sk || row.muscle_region_ge || '').trim();
}

function getMuscleCategoryLabel(row){
  const field = getMuscleCategoryField();
  return (row[field] || row.muscle_category_en || row.muscle_category_sk || row.muscle_category_ge || '').trim();
}

function addMuscleField(container, label, value, key, showToggles){
  const row = document.createElement('div');
  row.className = 'muscle-field';

  if(showToggles){
    const leftWrap = document.createElement('label');
    leftWrap.className = 'muscle-field-toggle';
    const leftCb = document.createElement('input');
    leftCb.type = 'checkbox';
    leftCb.checked = muscleQuizPersistentFields.has(key);
    leftCb.addEventListener('change', ()=>{
      if(leftCb.checked) muscleQuizPersistentFields.add(key);
      else muscleQuizPersistentFields.delete(key);
      renderMuscleQuizFields();
    });
    leftWrap.appendChild(leftCb);
    row.appendChild(leftWrap);
  }

  const l = document.createElement('div');
  l.className = 'muscle-field-label';
  l.textContent = label;
  const v = document.createElement('div');
  v.className = 'muscle-field-value';
  v.textContent = value || '—';
  row.appendChild(l);
  row.appendChild(v);

  if(showToggles){
    const rightWrap = document.createElement('label');
    rightWrap.className = 'muscle-field-toggle right';
    const rightCb = document.createElement('input');
    rightCb.type = 'checkbox';
    rightCb.checked = muscleQuizTempFields.has(key);
    rightCb.addEventListener('change', ()=>{
      if(rightCb.checked) muscleQuizTempFields.add(key);
      else muscleQuizTempFields.delete(key);
      renderMuscleQuizFields();
    });
    rightWrap.appendChild(rightCb);
    row.appendChild(rightWrap);
  }

  container.appendChild(row);
}

function renderMuscleSearchResults(){
  const input = document.getElementById('muscle-search-input');
  const fieldSel = document.getElementById('muscle-search-field');
  const results = document.getElementById('muscle-search-results');
  if(!input || !results) return;
  const q = input.value.trim().toLowerCase();
  results.innerHTML = '';
  if(q.length < 2) return;

  const regionField = getMuscleRegionField();
  const categoryField = getMuscleCategoryField();
  const mode = fieldSel ? fieldSel.value : 'any';
  const matches = muscleTerms.filter(r => {
    if(mode === 'region') return includesQuery(r[regionField], q);
    if(mode === 'category') return includesQuery(r[categoryField], q);
    if(mode === 'english_muscle_name') return includesQuery(r.english_muscle_name, q);
    if(mode === 'latin_muscle_name') return includesQuery(r.latin_muscle_name, q);
    if(mode === 'type_of_movement') return includesQuery(r.type_of_movement, q);
    if(mode === 'insercio') return includesQuery(r.insercio, q);
    if(mode === 'origo') return includesQuery(r.origo, q);
    if(mode === 'blood_supply') return includesQuery(r.blood_supply, q);
    if(mode === 'innervation') return includesQuery(r.innervation, q);
    return (
      includesQuery(r.english_muscle_name, q) ||
      includesQuery(r.latin_muscle_name, q) ||
      includesQuery(r[regionField], q) ||
      includesQuery(r[categoryField], q) ||
      includesQuery(r.muscle_part, q) ||
      includesQuery(r.type_of_movement, q) ||
      includesQuery(r.innervation, q) ||
      includesQuery(r.blood_supply, q) ||
      includesQuery(r.origo, q) ||
      includesQuery(r.insercio, q)
    );
  });

  if(matches.length === 0){
    results.textContent = 'No muscles found.';
    return;
  }

  const limit = 50;
  matches.slice(0, limit).forEach(r=>{
    const card = document.createElement('div');
    card.className = 'muscle-result';
    addMuscleField(card, t('muscle_search_region') || 'Region', getMuscleRegionLabel(r), null, false);
    addMuscleField(card, t('muscle_search_category') || 'Category', getMuscleCategoryLabel(r), null, false);
    addMuscleField(card, 'Latin name', r.latin_muscle_name, null, false);
    addMuscleField(card, 'English name', r.english_muscle_name, null, false);
    addMuscleField(card, 'Muscle part', r.muscle_part, null, false);
    addMuscleField(card, t('muscle_type_of_movement') || 'Type of movement', r.type_of_movement, null, false);
    addMuscleField(card, 'Innervation', r.innervation, null, false);
    addMuscleField(card, 'Blood supply', r.blood_supply, null, false);
    addMuscleField(card, 'Origo', r.origo, null, false);
    addMuscleField(card, 'Insercio', r.insercio, null, false);
    results.appendChild(card);
  });
  if(matches.length > limit){
    const note = document.createElement('div');
    note.className = 'muted';
    note.textContent = `Showing first ${limit} results.`;
    results.appendChild(note);
  }
}

function renderMuscleRegionList(){
  const list = document.getElementById('muscle-region-list');
  if(!list) return;
  const regionField = getMuscleRegionField();
  const categoryField = getMuscleCategoryField();
  const regions = new Map();
  for(const r of muscleTerms){
    const key = getMuscleRegionKey(r);
    if(!key) continue;
    const label = (r[regionField] || r.muscle_region_en || key).trim();
    if(!regions.has(key)){
      regions.set(key, { label: label || key, categories: new Map() });
    }
    const catKey = getMuscleCategoryKey(r);
    if(!catKey) continue;
    const catLabel = (r[categoryField] || r.muscle_category_en || catKey).trim();
    regions.get(key).categories.set(catKey, catLabel || catKey);
  }
  const keys = [...regions.keys()].sort((a,b)=>a.localeCompare(b));
  list.innerHTML = '';
  if(keys.length === 0){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'No regions available.';
    list.appendChild(empty);
    return;
  }
  keys.forEach(regionKey=>{
    const regionData = regions.get(regionKey);
    const wrapper = document.createElement('div');
    wrapper.className = 'muscle-region-item';

    const header = document.createElement('div');
    header.className = 'muscle-region-header';
    const regionCb = document.createElement('input');
    regionCb.type = 'checkbox';
    regionCb.checked = muscleQuizSelectedRegions.has(regionKey);
    const label = document.createElement('span');
    label.textContent = regionData.label;
    header.appendChild(regionCb);
    header.appendChild(label);
    wrapper.appendChild(header);

    const catWrap = document.createElement('div');
    catWrap.className = 'muscle-region-categories checkbox-grid';
    if(!regionCb.checked) catWrap.classList.add('hidden');

    const catKeys = [...regionData.categories.keys()].sort((a,b)=>a.localeCompare(b));
    if(catKeys.length === 0){
      const none = document.createElement('div');
      none.className = 'muted';
      none.textContent = 'No categories for this region.';
      catWrap.appendChild(none);
    }else{
      catKeys.forEach(catKey=>{
        const catLabel = regionData.categories.get(catKey);
        const item = document.createElement('label');
        item.className = 'checkbox-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        const key = `${regionKey}||${catKey}`;
        cb.value = key;
        cb.checked = muscleQuizSelectedCategories.has(key);
        cb.addEventListener('change', ()=>{
          if(cb.checked){
            muscleQuizSelectedCategories.add(key);
            muscleQuizSelectedRegions.add(regionKey);
            regionCb.checked = true;
            catWrap.classList.remove('hidden');
          } else {
            muscleQuizSelectedCategories.delete(key);
          }
        });
        const span = document.createElement('span');
        span.textContent = catLabel;
        item.appendChild(cb);
        item.appendChild(span);
        catWrap.appendChild(item);
      });
    }

    regionCb.addEventListener('change', ()=>{
      if(regionCb.checked){
        muscleQuizSelectedRegions.add(regionKey);
        catWrap.classList.remove('hidden');
      } else {
        muscleQuizSelectedRegions.delete(regionKey);
        catWrap.classList.add('hidden');
        [...catWrap.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
          cb.checked = false;
          muscleQuizSelectedCategories.delete(cb.value);
        });
      }
    });

    wrapper.appendChild(catWrap);
    list.appendChild(wrapper);
  });
}

function buildMuscleQuizPool(){
  const regions = [...muscleQuizSelectedRegions];
  const categories = [...muscleQuizSelectedCategories];
  if(regions.length === 0 || categories.length === 0) return [];
  return muscleTerms.filter(r => {
    const regionKey = getMuscleRegionKey(r);
    const catKey = getMuscleCategoryKey(r);
    return regions.includes(regionKey) && categories.includes(`${regionKey}||${catKey}`);
  });
}

function renderMuscleQuizFields(){
  const fields = document.getElementById('muscle-quiz-fields');
  const area = document.getElementById('muscle-quiz-area');
  if(!fields || !area) return;
  fields.innerHTML = '';
  if(!muscleQuizCurrent){
    area.classList.add('hidden');
    return;
  }
  const v = (value, key)=> {
    if(muscleQuizRevealed || muscleQuizPersistentFields.has(key) || muscleQuizTempFields.has(key)){
      return value || '—';
    }
    return MUSCLE_HIDDEN;
  };
  addMuscleField(fields, t('muscle_search_region') || 'Region', v(getMuscleRegionLabel(muscleQuizCurrent), 'region'), 'region', true);
  addMuscleField(fields, t('muscle_search_category') || 'Category', v(getMuscleCategoryLabel(muscleQuizCurrent), 'category'), 'category', true);
  addMuscleField(fields, 'Latin name', v(muscleQuizCurrent.latin_muscle_name, 'latin'), 'latin', true);
  addMuscleField(fields, 'English name', v(muscleQuizCurrent.english_muscle_name, 'english'), 'english', true);
  addMuscleField(fields, 'Muscle part', v(muscleQuizCurrent.muscle_part, 'part'), 'part', true);
  addMuscleField(fields, t('muscle_type_of_movement') || 'Type of movement', v(muscleQuizCurrent.type_of_movement, 'movement'), 'movement', true);
  addMuscleField(fields, 'Innervation', v(muscleQuizCurrent.innervation, 'innervation'), 'innervation', true);
  addMuscleField(fields, 'Blood supply', v(muscleQuizCurrent.blood_supply, 'blood_supply'), 'blood_supply', true);
  addMuscleField(fields, 'Origo', v(muscleQuizCurrent.origo, 'origo'), 'origo', true);
  addMuscleField(fields, 'Insercio', v(muscleQuizCurrent.insercio, 'insercio'), 'insercio', true);
  area.classList.remove('hidden');
}

function showNextMuscle(){
  if(!muscleQuizPool || muscleQuizPool.length === 0) return;
  muscleQuizCurrent = muscleQuizPool[Math.floor(Math.random() * muscleQuizPool.length)];
  muscleQuizRevealed = false;
  muscleQuizTempFields.clear();
  renderMuscleQuizFields();
}

function startMuscleQuiz(){
  const msg = document.getElementById('muscle-quiz-msg');
  if(msg) msg.textContent = '';
  muscleQuizPool = buildMuscleQuizPool();
  if(muscleQuizPool.length === 0){
    if(msg) msg.textContent = t('muscle_quiz_select_region') || 'Select a region and at least one group with data.';
    muscleQuizCurrent = null;
    renderMuscleQuizFields();
    return;
  }
  showNextMuscle();
}

function refreshMuscleTrainingUI(){
  renderMuscleRegionList();
  renderMuscleQuizFields();
  const input = document.getElementById('muscle-search-input');
  if(input && input.value.trim().length >= 2) renderMuscleSearchResults();
}

// --- Anamnesis helpers ---
let anamnesisSaveTimer = null;

function saveAnamnesisForm(){
  const form = document.getElementById('anamnesis-form');
  if(!form) return;
  const data = {};
  form.querySelectorAll('input, textarea, select').forEach(el=>{
    if(!el.name) return;
    if(el.type === 'checkbox') data[el.name] = el.checked;
    else if(el.type === 'radio'){
      if(el.checked) data[el.name] = el.value;
    } else {
      data[el.name] = el.value;
    }
  });
  localStorage.setItem(ANAMNESIS_STORAGE_KEY, JSON.stringify(data));
  const status = document.getElementById('anamnesis-status');
  if(status) status.textContent = 'Saved locally.';
}

function scheduleAnamnesisSave(){
  clearTimeout(anamnesisSaveTimer);
  anamnesisSaveTimer = setTimeout(saveAnamnesisForm, 300);
}

function loadAnamnesisForm(){
  const form = document.getElementById('anamnesis-form');
  if(!form) return;
  const raw = localStorage.getItem(ANAMNESIS_STORAGE_KEY);
  if(!raw) return;
  let data = null;
  try{ data = JSON.parse(raw); }catch(e){ data = null; }
  if(!data) return;
  form.querySelectorAll('input, textarea, select').forEach(el=>{
    if(!el.name || !(el.name in data)) return;
    if(el.type === 'checkbox') el.checked = !!data[el.name];
    else if(el.type === 'radio') el.checked = (data[el.name] === el.value);
    else el.value = data[el.name];
  });
}

function clearAnamnesisForm(){
  const form = document.getElementById('anamnesis-form');
  if(form) form.reset();
  localStorage.removeItem(ANAMNESIS_STORAGE_KEY);
  const status = document.getElementById('anamnesis-status');
  if(status) status.textContent = 'Cleared.';
}

function applyTextSize(step){
  const clamped = Math.max(1, Math.min(7, Number(step) || 4));
  const px = TEXT_SIZES[clamped - 1] || 16;
  document.body.style.setProperty('--base-font-size', px + 'px');
  localStorage.setItem(TEXT_SIZE_KEY, String(clamped));
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  const el = document.getElementById(id);
  if(el) el.classList.remove('hidden');
}

/* === NEW: auth UI (cog always visible + header user) === */
function updateAuthUI(){
  const cog = document.getElementById('settings-toggle');
  const who = document.getElementById('header-whoami');
  const whoUser = document.getElementById('header-user');
  const syncBlock = document.getElementById('settings-sync-block');

  const loggedIn = !!state.currentUser;
  if(loggedIn){
    if(cog) cog.classList.remove('hidden');
    who.classList.remove('hidden');
    whoUser.textContent = state.currentUser;
    if(syncBlock) syncBlock.classList.remove('hidden');
  } else {
    if(cog) cog.classList.remove('hidden');
    who.classList.add('hidden');
    whoUser.textContent = '???';
    if(syncBlock) syncBlock.classList.add('hidden');
    // ensure settings is closed if user logs out
    document.getElementById('settings-sidebar').classList.remove('open');
    document.getElementById('settings-overlay').classList.remove('open');
  }
}

async function logoutToLogin(){
  try{
    await supaSignOut();
  }catch(e){
    console.warn("Sign out failed:", e);
  }
  state.currentUser = null;
  state.currentUserEmail = null;
  document.getElementById('current-user').textContent = "(none)";
  updateAuthUI();
  document.getElementById('login-form').classList.remove('hidden');
  document.getElementById('register-form').classList.add('hidden');
  showScreen('screen-login');
}

async function init(){
  // Always try to refresh base CSV cache first (newest possible version)
  try{ await refreshBaseFilesCache(); }catch(e){ console.warn('Base CSV refresh skipped:', e); }

  await Promise.all([loadTranslations(), loadMedicalTerms(), loadMuscles()]);

    // Apply language instantly (no reload needed)
  await setLanguage(state.language);
// Settings sidebar handling
  const settingsBtn = document.getElementById('settings-toggle');
  const sidebar = document.getElementById('settings-sidebar');
  const overlay = document.getElementById('settings-overlay');
  const settingsClose = document.getElementById('settings-close');

  function openSettings(){
    sidebar.classList.add('open');
    overlay.classList.add('open');
  }
  function closeSettings(){
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
  }
  function toggleSettings(){
    if(sidebar.classList.contains('open')) closeSettings();
    else openSettings();
  }

  if(settingsBtn) settingsBtn.addEventListener('click', toggleSettings);
  if(overlay) overlay.addEventListener('click', closeSettings);
  if(settingsClose) settingsClose.addEventListener('click', closeSettings);

  // Hero language buttons
  document.querySelectorAll('.lang-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const lang = btn.getAttribute('data-lang');
      await setLanguage(lang);
    });
  });

  // Text size selection (7 steps)
  const sizeSlider = document.getElementById('text-size-slider');
  const savedSize = localStorage.getItem(TEXT_SIZE_KEY) || '4';
  applyTextSize(savedSize);
  if(sizeSlider){
    sizeSlider.value = savedSize;
    sizeSlider.addEventListener('input', ()=> applyTextSize(sizeSlider.value));
  }
on('to-login','click', ()=> showScreen('screen-login'));
  on('to-register','click', ()=> {
    showScreen('screen-login');
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.remove('hidden');
  });

  function openGuestModal(){
    const overlay = document.getElementById('guest-overlay');
    if(overlay) overlay.classList.remove('hidden');
  }
  function closeGuestModal(){
    const overlay = document.getElementById('guest-overlay');
    if(overlay) overlay.classList.add('hidden');
  }

  function openForgotModal(){
    const overlay = document.getElementById('forgot-overlay');
    const msg = document.getElementById('forgot-msg');
    const email = document.getElementById('forgot-email');
    if(msg) msg.textContent = '';
    if(email){
      const fromLogin = document.getElementById('username')?.value?.trim() || '';
      email.value = fromLogin.includes('@') ? fromLogin : '';
    }
    if(overlay) overlay.classList.remove('hidden');
  }
  function closeForgotModal(){
    const overlay = document.getElementById('forgot-overlay');
    if(overlay) overlay.classList.add('hidden');
  }

  on('continue-guest','click', ()=> openGuestModal());
  on('guest-back','click', ()=> closeGuestModal());
  on('guest-continue','click', ()=>{
    closeGuestModal();
    showScreen('screen-submenu');
  });
  on('forgot-cancel','click', ()=> closeForgotModal());
on('btn-show-register','click', ()=>{
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.remove('hidden');
  });
  on('btn-show-login','click', ()=>{
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
  });

  on('btn-register','click', async () => {
    clearLoginStatus();
    const username = document.getElementById('reg-username').value.trim();
    const emailInput = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirm = document.getElementById('reg-password-confirm').value;
    const msg = document.getElementById('register-msg');
    msg.textContent='';

    if (!username || !emailInput || !password) {
      setLoginStatus("Please fill all fields", "error");
      return;
    }
    if (password !== confirm) {
      setLoginStatus("Passwords do not match", "error");
      return;
    }

    const email = emailInput;

    try {
      setLoginStatus("Creating account…");
      await supaSignUp(email, password, username);
      setDisplayNameMapping(username, email);

      const session = await supaGetSession();
      if (session) {
        setLoginStatus("Account created. You can log in now.", "ok");
      } else {
        setLoginStatus("Account created. Please confirm your email, then log in.", "info");
      }
      msg.textContent = t('Registration successful! You can now log in.') || 'Registration successful! You can now log in.';
      document.getElementById('reg-username').value='';
      document.getElementById('reg-email').value='';
      document.getElementById('reg-password').value='';
      document.getElementById('reg-password-confirm').value='';
    } catch (e) {
      console.error(e);
      setLoginStatus("Registration failed: " + e.message, "error");
      msg.textContent = (e.message || String(e));
    }
  });

  on('btn-login','click', async () => {
    clearLoginStatus();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const msg = document.getElementById('login-msg');
    msg.textContent='';

    if (!username || !password) {
      setLoginStatus(t("login_missing_fields") || "Enter username and password", "error");
      return;
    }

    let email = "";
    if(username.includes("@")) email = username;
    else email = lookupEmailByDisplayName(username);
    if(!email){
      setLoginStatus("Unknown display name. Use your email.", "error");
      return;
    }

    try {
      setLoginStatus("Signing in???");
      await supaSignIn(email, password);

      const session = await supaGetSession();
      const displayName = session?.user?.user_metadata?.name || username;
      state.currentUser = displayName;
      state.currentUserEmail = session?.user?.email || email;

      // Update who is logged in (settings + header)
      document.getElementById('current-user').textContent = displayName;
      updateAuthUI();

      setLoginStatus("Signed in. Sync active.", "ok");
      showScreen("screen-submenu");

// Pull newest base CSVs into offline cache on login (if available), then reload from cache
try{
  await refreshBaseFilesCache();
  await Promise.all([loadTranslations(), loadMedicalTerms(), loadMuscles()]);
  applyTranslationsToDom();
  refreshMuscleTrainingUI();
}catch(e){
  console.warn("Base CSV refresh failed (offline/local only):", e);
}

try{
        setSyncStatus("loading...");
        const [remoteTerms, remoteReview] = await Promise.all([supaFetchUserTerms(), supaFetchUserReview()]);
        setLocalTerms(mergeById(getLocalTerms(), remoteTerms));
        setLocalReview(mergeById(getLocalReview(), remoteReview));
        setSyncStatus("ready");
      }catch(e){
        console.warn("Initial remote load failed (offline/local only):", e);
        setSyncStatus("offline/local only");
      }

    } catch (e) {
      console.error(e);
      setLoginStatus("Login failed: " + e.message, "error");
      msg.textContent = t('Invalid credentials.') || 'Invalid credentials.';
    }
  });

  on('btn-forgot','click', async () => {
    openForgotModal();
  });

  on('forgot-send','click', async () => {
    clearLoginStatus();
    const msg = document.getElementById('forgot-msg');
    const email = document.getElementById('forgot-email').value.trim();
    if(!email){
      if(msg) msg.textContent = t('forgot_password_email_required') || 'Email is required.';
      return;
    }
    try{
      if(msg) msg.textContent = t('forgot_password_sending') || 'Sending reset email...';
      await supaRequestPasswordReset(email);
      if(msg) msg.textContent = t('forgot_password_sent_msg') || 'Reset email sent.';
    }catch(e){
      console.error(e);
      if(msg) msg.textContent = (t('forgot_password_failed') || 'Reset failed: ') + (e.message || e);
    }
  });

  on('to-search','click', ()=> { showScreen('screen-search'); });
  on('to-entry','click', ()=> { showScreen('screen-entry'); });
  on('to-quiz','click', ()=> { showScreen('screen-quiz'); });
  on('to-muscle-training','click', ()=> { showScreen('screen-muscle-training'); });
  on('to-anamnesis','click', ()=> { showScreen('screen-anamnesis'); loadAnamnesisForm(); });

  // moved to settings sidebar (same IDs)
  on('to-menu','click', ()=> { showScreen('screen-menu'); });
  on('to-login-from-settings','click', async ()=> { await logoutToLogin(); });
  on('btn-sync','click', async ()=>{ await syncNow(); });

  updateDirtyCount();

  const searchInput = document.getElementById('search-input');
  const resultsDiv = document.getElementById('search-results');

  const muscleSearchInput = document.getElementById('muscle-search-input');
  if(muscleSearchInput){
    muscleSearchInput.addEventListener('input', renderMuscleSearchResults);
  }
  const muscleSearchField = document.getElementById('muscle-search-field');
  if(muscleSearchField){
    const saved = localStorage.getItem(MUSCLE_SEARCH_FIELD_KEY);
    if(saved && [...muscleSearchField.options].some(o=>o.value === saved)){
      muscleSearchField.value = saved;
    }
    muscleSearchField.addEventListener('change', renderMuscleSearchResults);
    muscleSearchField.addEventListener('change', ()=>{
      localStorage.setItem(MUSCLE_SEARCH_FIELD_KEY, muscleSearchField.value);
    });
  }
  on('muscle-quiz-start','click', ()=> startMuscleQuiz());
  on('muscle-quiz-reveal','click', ()=>{ muscleQuizRevealed = true; renderMuscleQuizFields(); });
  on('muscle-quiz-next','click', ()=> showNextMuscle());
  on('muscle-training-back','click', ()=> showScreen('screen-submenu'));

  const anamForm = document.getElementById('anamnesis-form');
  if(anamForm){
    anamForm.addEventListener('input', scheduleAnamnesisSave);
    anamForm.addEventListener('change', scheduleAnamnesisSave);
  }
  on('anamnesis-clear','click', ()=> clearAnamnesisForm());
  on('anamnesis-back','click', ()=> showScreen('screen-submenu'));

  searchInput.addEventListener('input', ()=>{
    const q = searchInput.value.trim().toLowerCase();
    resultsDiv.innerHTML='';
    if(q.length<2) return;

    const results = [];
    const seenBase = new Set();
    const seenUser = new Set();
    const langField = getBaseSearchField();
    const userField = getUserSearchField();

    for(const r of medicalTerms){
      if(includesQuery(r[langField], q)){
        results.push({ kind:'base', row:r });
        seenBase.add(r);
      }
    }

    for(const t of getLocalTerms()){
      if(includesQuery(t && t[userField], q)){
        results.push({ kind:'user', row:t });
        seenUser.add(t);
      }
    }

    if(results.length === 0){
      for(const r of medicalTerms){
        if(!seenBase.has(r) && matchAnyField(r, BASE_SEARCH_FIELDS, q)){
          results.push({ kind:'base', row:r });
          seenBase.add(r);
        }
      }
      for(const t of getLocalTerms()){
        if(!seenUser.has(t) && matchAnyField(t || {}, USER_SEARCH_FIELDS, q)){
          results.push({ kind:'user', row:t });
          seenUser.add(t);
        }
      }
    }

    if(results.length===0){
      resultsDiv.textContent = t('No matching results found.') || 'No matching results found.';
      return;
    }

    for(const item of results){
      const el = document.createElement('div');
      el.className='result';
      if(item.kind === 'base'){
        const row = item.row;
        const head = (row[langField]||row['latin_translation']||row['english_translation']||'').trim();
        const def = (row['english_definition']||'').trim();
        el.innerHTML = `<strong>${head}</strong>${def?`<div class="muted" style="margin-top:6px">${def}</div>`:''}
          <div class="kv">
            <div class="k">Latin</div><div class="v">${row['latin_translation']||''}</div>
            <div class="k">English</div><div class="v">${row['english_translation']||''}</div>
            <div class="k">German</div><div class="v">${row['german_translation']||''}</div>
            <div class="k">Slovak</div><div class="v">${row['slovak_translation']||''}</div>
          </div>`;
      } else {
        const row = item.row;
        const head = (row[userField]||row.latin||row.english||'').trim();
        const def = (row.notes||'').trim();
        el.innerHTML = `<strong>${head}</strong>${def?`<div class="muted" style="margin-top:6px">${def}</div>`:''}
          <div class="kv">
            <div class="k">Latin</div><div class="v">${row.latin||''}</div>
            <div class="k">English</div><div class="v">${row.english||''}</div>
            <div class="k">German</div><div class="v">${row.german||''}</div>
            <div class="k">Slovak</div><div class="v">${row.slovak||''}</div>
          </div>`;
      }
      resultsDiv.appendChild(el);
    }
  });

  on('search-back','click', ()=> showScreen('screen-submenu'));

  on('save-term','click', async ()=>{
    if(!state.currentUser){
      document.getElementById('entry-msg').textContent = t('Please login first.') || 'Please login first.';
      return;
    }
    const fields = [...document.querySelectorAll('#entry-fields [data-field]')];
    const raw = {};
    for(const el of fields) raw[el.dataset.field] = el.value.trim();

    const term = {
      id: null,
      english: raw.english_translation || null,
      german: raw.german_translation || null,
      latin: raw.latin_translation || null,
      slovak: raw.slovak_translation || null,
      spanish: raw.spanish_translation || null,
      notes: raw.english_definition || raw.german_definition || null,
      source_dataset: "manual_entry",
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      dirty: true
    };

    const terms = getLocalTerms();
    terms.unshift(term);
    setLocalTerms(terms);

    document.getElementById('entry-msg').textContent =
      (t('Term saved successfully!') || 'Term saved successfully!') + ' (saved locally — press Sync)';
    fields.forEach(f=>f.value='');
  });

  on('entry-back','click', ()=> showScreen('screen-submenu'));
  on('start-quiz','click', ()=> startQuiz());
  on('quiz-back','click', ()=> showScreen('screen-submenu'));

  // initial state: not logged in => hide cog + header whoami
  updateAuthUI();

  showScreen('screen-menu');
  applyTranslationsToDom();
}

function startQuiz(){
  const from = document.getElementById('quiz-from').value;
  const to = document.getElementById('quiz-to').value;
  const fromUser = mapUserFieldFromBase(from);
  const toUser = mapUserFieldFromBase(to);
  const area = document.getElementById('quiz-area');
  area.innerHTML='';
  const scoreEl = document.getElementById('quiz-score');
  scoreEl.textContent='';

  const pool = [];
  for(const r of medicalTerms) if(r[from] && r[to]) pool.push({from: r[from], to: r[to]});
  if(state.currentUser){
    const added = getLocalTerms();
    for(const r of added) if(r && r[fromUser] && r[toUser]) pool.push({from: r[fromUser], to: r[toUser]});
  }
  if(pool.length === 0){
    area.textContent = t('No pairs available for this selection.') || 'No pairs available for this selection.';
    return;
  }

  shuffle(pool);
  let score=0;
  let answeredTotal=0;
  let index=0;

  const renderBatch = () => {
    area.innerHTML='';
    const quizItems = pool.slice(index, index + 5);
    if(quizItems.length === 0){
      area.textContent = t('Quiz complete.') || 'Quiz complete.';
      return;
    }
    let answeredInBatch=0;

    quizItems.forEach((it, idx)=>{
      const qdiv = document.createElement('div');
      qdiv.className='quiz-item';
      const q = document.createElement('div');
      q.innerHTML = `<strong>Q${index + idx + 1}:</strong> ${it.from}`;
      qdiv.appendChild(q);

      const choices = [it.to];
      for(let i=0;i<20 && choices.length<4;i++){
        const cand = pool[Math.floor(Math.random()*pool.length)].to;
        if(cand && !choices.includes(cand)) choices.push(cand);
      }
      shuffle(choices);

      const ul = document.createElement('div');
      ul.className='choices';
      let answered=false;
      choices.forEach(ch=>{
        const btn = document.createElement('button');
        btn.textContent=ch;
        btn.addEventListener('click', ()=>{
          if(answered) return;
          answered=true;
          [...ul.querySelectorAll('button')].forEach(b=>{
            b.disabled = true;
            b.classList.add('answered');
          });
          if(ch===it.to){ btn.style.background='lightgreen'; score++; }
          else { btn.style.background='indianred'; }
          answeredInBatch++;
          answeredTotal++;
          scoreEl.textContent = `${t('score')||'Score'}: ${score} / ${answeredTotal}`;
          if(answeredInBatch === quizItems.length){
            index += quizItems.length;
            if(index < pool.length){
              setTimeout(renderBatch, 250);
            }else{
              const done = document.createElement('div');
              done.className='muted';
              done.textContent = t('Quiz complete.') || 'Quiz complete.';
              area.appendChild(done);
            }
          }
        });
        ul.appendChild(btn);
      });
      qdiv.appendChild(ul);
      area.appendChild(qdiv);
    });

    scoreEl.textContent = `${t('score')||'Score'}: ${score} / ${answeredTotal}`;
  };

  renderBatch();
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

window.addEventListener('DOMContentLoaded', ()=>{ init(); });
  </script>
</body>
</html>

